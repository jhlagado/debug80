FLAG_HOSTILE_CREATURE_INDEX = 0    rem 0 or 1..6
FLAG_CANDLE_LIT            = 1    rem 0/1
FLAG_HUT_VISITED           = 2    rem 0/1 (pseudo3 GENERAL_FLAG_J)
FLAG_BRIDGE_CONDITION      = 10   rem 0/room/EXIT_FATAL (patched movement)
FLAG_DRAWBRIDGE_STATE      = 11   rem 0/room/EXIT_FATAL (patched movement)
FLAG_WATER_EXIT_LOCATION   = 12   rem 0/room (patched movement)
FLAG_GATE_DESTINATION      = 13   rem 0/room (patched movement)
FLAG_TELEPORT_DESTINATION  = 14   rem 0/room (patched movement)
FLAG_SECRET_EXIT_LOCATION  = 15   rem 0/room (patched movement)
FLAG_CURRENT_VERB          = 20   rem parsed verb enum
FLAG_CURRENT_DIR           = 21   rem 0..3, or 0xFF for none
FLAG_CURRENT_OBJECT        = 22   rem 0 or 7..24
FLAG_SPECIAL_WORD          = 23   rem enum: none/look/list/quit/galar/ape
FLAG_SWORD_SWING_COUNT     = 30
FLAG_SCORE                 = 31

goto DATA_DRIVEN_START


SPECIAL_NONE  = 0
SPECIAL_LOOK  = 1
SPECIAL_LIST  = 2
SPECIAL_QUIT  = 3
SPECIAL_GALAR = 4
SPECIAL_APE   = 5

VERB_NONE = 0
VERB_GET  = 1
VERB_DROP = 2
VERB_USE  = 3


TEXT_DARKNESS                     = 1
TEXT_DRAINAGE_SYSTEM              = 2
TEXT_DEEP_DARK_CAVERN             = 3
TEXT_BRIDGE_ROPES_SNAPPED         = 4
TEXT_DRAGON_CORPSE                = 5
TEXT_DRAWBRIDGE_SPANS_WATERS      = 6
TEXT_CANDLE_GROWING_DIM           = 7
TEXT_CANDLE_WENT_OUT              = 8

TEXT_YOU_CAN_ALSO_SEE             = 9
TEXT_NEARBY_THERE_LURKS           = 10
TEXT_PROMPT                       = 11

TEXT_INVENTORY_PREFIX             = 12   rem "You are carrying "
TEXT_INVENTORY_NOTHING            = 13   rem "nothing."

TEXT_SCORE_LINE                   = 14   rem formatted line in ACT_QUIT_AND_SCORE
TEXT_ANOTHER_ADVENTURE            = 15

TEXT_BAT_CARRIES_YOU              = 16
TEXT_MONSTER_KILLS_YOU            = 17   rem formatted line in ACT_MONSTER_ATTACK_AND_KILL

TEXT_CANT_GO_THAT_WAY             = 18
TEXT_FALL_AND_DIE                 = 19

TEXT_TELEPORT_WIND                = 20
TEXT_CRYPT_WALL_OPENS             = 21

TEXT_EH                           = 22
TEXT_WHERE_CANT_SEE_IT            = 23
TEXT_TOO_MANY_OBJECTS             = 24
TEXT_DONT_KNOW_HOW_TO_USE         = 25

TEXT_IT_WONT_OPEN                 = 26
TEXT_OPENED_THE_DOOR              = 27

TEXT_NOTHING_TO_KILL              = 28
TEXT_SWORD_MISS_YOU_DIE           = 29
TEXT_SWORD_ATTACK_MISSED          = 30
TEXT_SWORD_DEFLECTED              = 31
TEXT_SWORD_STUNNED                = 32
TEXT_SWORD_YOU_GOT_HIT            = 33
TEXT_SWORD_STRIKES_HOME           = 34
TEXT_SWORD_CRUMBLES               = 35
TEXT_CORPSE_VAPORIZES             = 36

TEXT_BOMB_WONT_BURN_CANDLE_OUT     = 37
TEXT_CANDLE_OUT_INSULT            = 38
TEXT_BOMB_BOOM_LUCKY              = 39

TEXT_TOO_DANGEROUS                = 40
TEXT_ROPE_DESCEND                 = 41

TEXT_PATTERN_NOTHING_HAPPENS       = 42
TEXT_PATTERN_PLEASE_TELL_ME_HOW    = 43
TEXT_PATTERN_I_CANT               = 44

TEXT_RANKING_HEADER               = 45
TEXT_RANKING_HOPELESS_BEGINNER     = 46
TEXT_RANKING_EXPERIENCED_LOSER     = 47
TEXT_RANKING_AVERAGE_VIKING        = 48
TEXT_RANKING_EXCELLENT_LEFT_BEHIND = 49
TEXT_RANKING_PERFECTIONIST        = 50

TEXT_ENCOUNTER_WIZARD              = 51
TEXT_ENCOUNTER_DRAGON_1            = 52
TEXT_ENCOUNTER_DRAGON_2            = 53
TEXT_ENCOUNTER_DWARF               = 54


RULE_TABLE:

    DB PHASE_ON_COMMAND: DW GUARD_SPECIAL_LOOK:        DW ACT_FORCE_REDESCRIBE
    DB PHASE_ON_COMMAND: DW GUARD_SPECIAL_LIST:        DW ACT_PRINT_INVENTORY
    DB PHASE_ON_COMMAND: DW GUARD_SPECIAL_QUIT:        DW ACT_QUIT_AND_SCORE
    DB PHASE_ON_COMMAND: DW GUARD_SPECIAL_GALAR:       DW ACT_TELEPORT_TO_CAVE_ENTRY
    DB PHASE_ON_COMMAND: DW GUARD_SPECIAL_APE:         DW ACT_OPEN_CRYPT_SECRET_EXIT_AND_PATCH

    DB PHASE_ON_COMMAND: DW GUARD_HAS_DIRECTION:       DW ACT_RESOLVE_MOVEMENT

    DB PHASE_ON_COMMAND: DW GUARD_NO_OBJECT_PARSED:    DW ACT_PRINT_EH
    DB PHASE_ON_COMMAND: DW GUARD_OBJECT_NOT_VISIBLE:  DW ACT_PRINT_WHERE_I_CANT_SEE_IT

    DB PHASE_ON_COMMAND: DW GUARD_VERB_GET:            DW ACT_TRY_GET_CURRENT_OBJECT
    DB PHASE_ON_COMMAND: DW GUARD_VERB_DROP:           DW ACT_DROP_CURRENT_OBJECT

    DB PHASE_ON_COMMAND: DW GUARD_USE_KEY_BAD_LOCATION: DW ACT_PRINT_IT_WONT_OPEN
    DB PHASE_ON_COMMAND: DW GUARD_USE_KEY_FOREST:       DW ACT_USE_KEY_FOREST
    DB PHASE_ON_COMMAND: DW GUARD_USE_KEY_TEMPLE:       DW ACT_USE_KEY_TEMPLE

    DB PHASE_ON_COMMAND: DW GUARD_USE_SWORD_NO_HOSTILE: DW ACT_PRINT_NOTHING_TO_KILL
    DB PHASE_ON_COMMAND: DW GUARD_USE_SWORD_HOSTILE:    DW ACT_SWORD_COMBAT

    DB PHASE_ON_COMMAND: DW GUARD_USE_BOMB:             DW ACT_USE_BOMB
    DB PHASE_ON_COMMAND: DW GUARD_USE_ROPE_BAD_LOCATION:DW ACT_PRINT_TOO_DANGEROUS
    DB PHASE_ON_COMMAND: DW GUARD_USE_ROPE_OK:          DW ACT_USE_ROPE

    DB PHASE_ON_COMMAND: DW GUARD_PATTERN_RESPONSE:     DW ACT_PRINT_PATTERN_RESPONSE

    DB PHASE_ON_COMMAND: DW GUARD_ALWAYS:               DW ACT_PRINT_EH

    DB PHASE_ON_ENTER: DW GUARD_AT_BRIDGE_MID:        DW ACT_SET_BRIDGE_FATAL_AND_PATCH
    DB PHASE_ON_ENTER: DW GUARD_AT_FOREST_CLEARING:   DW ACT_SET_HUT_VISITED
    DB PHASE_ON_ENTER: DW GUARD_AT_WATERFALL_BASE:    DW ACT_ENABLE_WATER_EXIT_AND_PATCH
    DB PHASE_ON_ENTER: DW GUARD_AT_TEMPLE:            DW ACT_DISABLE_WATER_EXIT_AND_PATCH
    DB PHASE_ON_ENTER: DW GUARD_GRILL_NOT_IN_TINY_CELL: DW ACT_SET_GATE_DEST_AND_PATCH
    DB PHASE_ON_ENTER: DW GUARD_AT_DRAWBRIDGE:        DW ACT_SET_DRAWBRIDGE_AND_PATCH

    DB PHASE_ON_ENTER: DW GUARD_BAT_PRESENT:          DW ACT_BAT_CARRY

    DB PHASE_ON_ENTER: DW GUARD_ALWAYS:               DW ACT_NOOP

    DB PHASE_DESCRIBE: DW GUARD_HOSTILE_ATTACKABLE:   DW ACT_MONSTER_ATTACK_AND_KILL

    DB PHASE_DESCRIBE: DW GUARD_BRIGHT_BY_ROOM:       DW ACT_DESCRIBE_LIT
    DB PHASE_DESCRIBE: DW GUARD_BRIGHT_BY_CANDLE:     DW ACT_DESCRIBE_LIT
    DB PHASE_DESCRIBE: DW GUARD_ALWAYS:               DW ACT_DESCRIBE_DARK


GUARD_ALWAYS:
    DB G_END, 0, 0

GUARD_SPECIAL_LOOK:
    DB G_FLAG_EQ, FLAG_SPECIAL_WORD, SPECIAL_LOOK
    DB G_END, 0, 0

GUARD_SPECIAL_LIST:
    DB G_FLAG_EQ, FLAG_SPECIAL_WORD, SPECIAL_LIST
    DB G_END, 0, 0

GUARD_SPECIAL_QUIT:
    DB G_FLAG_EQ, FLAG_SPECIAL_WORD, SPECIAL_QUIT
    DB G_END, 0, 0

GUARD_SPECIAL_GALAR:
    DB G_FLAG_EQ, FLAG_SPECIAL_WORD, SPECIAL_GALAR
    DB G_END, 0, 0

GUARD_SPECIAL_APE:
    DB G_FLAG_EQ, FLAG_SPECIAL_WORD, SPECIAL_APE
    DB G_END, 0, 0

GUARD_HAS_DIRECTION:
    DB G_FLAG_NE, FLAG_CURRENT_DIR, 255
    DB G_END, 0, 0

GUARD_NO_OBJECT_PARSED:
    DB G_FLAG_EQ, FLAG_CURRENT_OBJECT, 0
    DB G_END, 0, 0

GUARD_OBJECT_NOT_VISIBLE:
    DB G_FLAG_NE, FLAG_CURRENT_OBJECT, 0
    DB 0x80 + G_ENT_VISIBLE_CURRENT, FLAG_CURRENT_OBJECT, 0
    DB G_END, 0, 0

GUARD_VERB_GET:
    DB G_FLAG_EQ, FLAG_CURRENT_VERB, VERB_GET
    DB G_END, 0, 0

GUARD_VERB_DROP:
    DB G_FLAG_EQ, FLAG_CURRENT_VERB, VERB_DROP
    DB G_END, 0, 0

GUARD_USE_KEY_BAD_LOCATION:
    DB G_FLAG_EQ, FLAG_CURRENT_VERB, VERB_USE
    DB G_FLAG_EQ, FLAG_CURRENT_OBJECT, OBJ_KEY
    DB 0x80 + G_AT, ROOM_FOREST_CLEARING, 0
    DB 0x80 + G_AT, ROOM_TEMPLE, 0
    DB G_END, 0, 0

GUARD_USE_KEY_FOREST:
    DB G_FLAG_EQ, FLAG_CURRENT_VERB, VERB_USE
    DB G_FLAG_EQ, FLAG_CURRENT_OBJECT, OBJ_KEY
    DB G_AT, ROOM_FOREST_CLEARING, 0
    DB G_END, 0, 0

GUARD_USE_KEY_TEMPLE:
    DB G_FLAG_EQ, FLAG_CURRENT_VERB, VERB_USE
    DB G_FLAG_EQ, FLAG_CURRENT_OBJECT, OBJ_KEY
    DB G_AT, ROOM_TEMPLE, 0
    DB G_END, 0, 0

GUARD_USE_SWORD_NO_HOSTILE:
    DB G_FLAG_EQ, FLAG_CURRENT_VERB, VERB_USE
    DB G_FLAG_EQ, FLAG_CURRENT_OBJECT, OBJ_SWORD
    DB G_FLAG_EQ, FLAG_HOSTILE_CREATURE_INDEX, 0
    DB G_END, 0, 0

GUARD_USE_SWORD_HOSTILE:
    DB G_FLAG_EQ, FLAG_CURRENT_VERB, VERB_USE
    DB G_FLAG_EQ, FLAG_CURRENT_OBJECT, OBJ_SWORD
    DB G_FLAG_NE, FLAG_HOSTILE_CREATURE_INDEX, 0
    DB G_END, 0, 0

GUARD_USE_BOMB:
    DB G_FLAG_EQ, FLAG_CURRENT_VERB, VERB_USE
    DB G_FLAG_EQ, FLAG_CURRENT_OBJECT, OBJ_CANDLE
    DB G_END, 0, 0

GUARD_USE_ROPE_BAD_LOCATION:
    DB G_FLAG_EQ, FLAG_CURRENT_VERB, VERB_USE
    DB G_FLAG_EQ, FLAG_CURRENT_OBJECT, OBJ_ROPE
    DB 0x80 + G_AT, ROOM_TEMPLE_BALCONY, 0
    DB G_END, 0, 0

GUARD_USE_ROPE_OK:
    DB G_FLAG_EQ, FLAG_CURRENT_VERB, VERB_USE
    DB G_FLAG_EQ, FLAG_CURRENT_OBJECT, OBJ_ROPE
    DB G_AT, ROOM_TEMPLE_BALCONY, 0
    DB G_END, 0, 0

FLAG_VERB_PATTERN_INDEX = 24

GUARD_PATTERN_RESPONSE:
    DB G_FLAG_NE, FLAG_VERB_PATTERN_INDEX, 0
    DB G_FLAG_EQ, FLAG_CURRENT_VERB, VERB_NONE
    DB G_END, 0, 0

GUARD_AT_BRIDGE_MID:
    DB G_AT, ROOM_BRIDGE_MID, 0
    DB G_END, 0, 0

GUARD_AT_FOREST_CLEARING:
    DB G_AT, ROOM_FOREST_CLEARING, 0
    DB G_END, 0, 0

GUARD_AT_WATERFALL_BASE:
    DB G_AT, ROOM_WATERFALL_BASE, 0
    DB G_END, 0, 0

GUARD_AT_TEMPLE:
    DB G_AT, ROOM_TEMPLE, 0
    DB G_END, 0, 0

GUARD_AT_DRAWBRIDGE:
    DB G_AT, ROOM_DRAWBRIDGE, 0
    DB G_END, 0, 0

GUARD_GRILL_NOT_IN_TINY_CELL:
    DB 0x80 + G_ENT_AT_ROOM, OBJ_GRILL, ROOM_TINY_CELL
    DB G_END, 0, 0

GUARD_BAT_PRESENT:
    DB G_ENT_AT_PLAYER, ENT_BAT, 0
    DB G_END, 0, 0

GUARD_HOSTILE_ATTACKABLE:
    DB G_FLAG_NE, FLAG_HOSTILE_CREATURE_INDEX, 0
    DB G_FLAG_NE, FLAG_HOSTILE_CREATURE_INDEX, ENT_BAT
    DB G_FLAG_NE, FLAG_CURRENT_OBJECT, OBJ_SWORD
    DB G_END, 0, 0

GUARD_BRIGHT_BY_ROOM:
    DB G_ROOM_LT, ROOM_DARK_CAVERN_A, 0
    DB G_END, 0, 0

GUARD_BRIGHT_BY_CANDLE:
    DB G_FLAG_EQ, FLAG_CANDLE_LIT, 1
    DB G_ENT_VISIBLE, OBJ_CANDLE, 0
    DB G_END, 0, 0


ROOM_MAX = 54
DIR_NORTH_STR=0: DIR_SOUTH_STR=1: DIR_WEST_STR=2: DIR_EAST_STR=3
EXIT_NONE = 0
EXIT_FATAL = 128

ROOM_DARK_ROOM = 1
ROOM_FOREST_CLEARING = 2
ROOM_DARK_FOREST = 3
ROOM_CLOVER_FIELD = 4
ROOM_RIVER_CLIFF = 5
ROOM_RIVER_BANK = 6
ROOM_CRATER_EDGE = 7
ROOM_RIVER_OUTCROP = 8
ROOM_MT_YMIR_SLOPE = 9
ROOM_BRIDGE_NORTH_ANCHOR = 10
ROOM_BRIDGE_MID = 11
ROOM_BRIDGE_SOUTH_ANCHOR = 12
ROOM_MUSHROOM_ROCK = 13
ROOM_CAVE_ENTRANCE_CLEARING = 14
ROOM_CLIFF_FACE = 15
ROOM_CAVE_ENTRY = 16
ROOM_DEAD_END_INSCRIPTION = 17
ROOM_DARK_CAVERN_A = 18
ROOM_TREASURE_ROOM = 19
ROOM_OAK_DOOR = 20
ROOM_DARK_CAVERN_B = 21
ROOM_WIND_CORRIDOR = 22
ROOM_TORTURE_CHAMBER = 23
ROOM_NORTH_SOUTH_TUNNEL = 24
ROOM_DARK_CAVERN_C = 25
ROOM_ROUND_ROOM = 26
ROOM_LEDGE_OVER_RIVER = 27
ROOM_TEMPLE_BALCONY = 28
ROOM_DARK_CAVERN_D = 29
ROOM_DARK_CAVERN_E = 30
ROOM_DARK_CAVERN_F = 31
ROOM_DARK_CAVERN_G = 32
ROOM_BAT_CAVE = 33
ROOM_DARK_CAVERN_H = 34
ROOM_TEMPLE = 35
ROOM_DARK_CAVERN_I = 36
ROOM_CRYPT = 37
ROOM_TINY_CELL = 38
ROOM_DARK_CAVERN_J = 39
ROOM_LEDGE_WATERFALL_IN = 40
ROOM_DRAIN_A = 41
ROOM_DRAIN_B = 42
ROOM_DRAIN_C = 43
ROOM_DRAIN_D = 44
ROOM_WATERFALL_BASE = 45
ROOM_DARK_CAVERN_K = 46
ROOM_STONE_STAIRCASE = 47
ROOM_CASTLE_LEDGE = 48
ROOM_DRAWBRIDGE = 49
ROOM_CASTLE_COURTYARD = 50
ROOM_POWDER_MAG = 51
ROOM_EAST_RIVERBANK = 52
ROOM_WOODEN_BRIDGE = 53
ROOM_RIVER_CONDUIT = 54

ENT_WIZARD=1: ENT_DEMON=2: ENT_TROLL=3: ENT_DRAGON=4: ENT_BAT=5: ENT_DWARF=6
OBJ_BOMB=9: OBJ_KEY=19: OBJ_SWORD=20: OBJ_CANDLE=21: OBJ_ROPE=22: OBJ_GRILL=24

ENT_LOC_CARRIED = 255
ENT_LOC_REMOVED = 0

PHASE_DESCRIBE=0: PHASE_ON_ENTER=1: PHASE_ON_COMMAND=2


SPECIAL_NONE  = 0
SPECIAL_LOOK  = 1
SPECIAL_LIST  = 2
SPECIAL_QUIT  = 3
SPECIAL_GALAR = 4
SPECIAL_APE   = 5

VERB_NONE = 0
VERB_GET  = 1
VERB_DROP = 2
VERB_USE  = 3


PLAYER_ALIVE = 1
PLAYER_LOCATION = ROOM_DARK_ROOM
TURN_COUNTER = 0
dim ENTITY_LOCATION(24)
dim FLAGS(64)

NULL = 0

dim MOVEMENT_TABLE(ROOM_MAX,3)
dim ROOM_DESC1_PTR(ROOM_MAX), ROOM_DESC2_PTR(ROOM_MAX)
dim OBJECT_NAME_ADJ(24), OBJECT_NAME_NOUN(24)
dim MONSTER_ADJ(6), MONSTER_NOUN(6)
dim VERB_PATTERN(16)
dim DIR_WORD_INDEX(4)
dim OBJDESC1(24), OBJDESC2(24)

FLAG_HOSTILE_CREATURE_INDEX = 0
FLAG_CANDLE_LIT            = 1
FLAG_HUT_VISITED           = 2
FLAG_BRIDGE_CONDITION      = 10
FLAG_DRAWBRIDGE_STATE      = 11
FLAG_WATER_EXIT_LOCATION   = 12
FLAG_GATE_DESTINATION      = 13
FLAG_TELEPORT_DESTINATION  = 14
FLAG_SECRET_EXIT_LOCATION  = 15
FLAG_CURRENT_VERB          = 20
FLAG_CURRENT_DIR           = 21
FLAG_CURRENT_OBJECT        = 22
FLAG_SPECIAL_WORD          = 23
FLAG_VERB_PATTERN_INDEX    = 24
FLAG_SWORD_SWING_COUNT     = 30
FLAG_SCORE                 = 31
FLAG_PLAYER_MOVED          = 40


G_END=0
G_AND=1
G_OR=2
G_AT=3
G_ROOM_LT=4
G_FLAG_EQ=5
G_FLAG_NE=6
G_ENT_AT_ROOM=7
G_ENT_AT_PLAYER=8
G_ENT_CARRIED=9
G_ENT_VISIBLE=10
G_ENT_VISIBLE_CURRENT=11


ACT_FORCE_REDESCRIBE = 1
ACT_PRINT_INVENTORY = 2
ACT_QUIT_AND_SCORE = 3
ACT_TELEPORT_TO_CAVE_ENTRY = 4
ACT_OPEN_CRYPT_SECRET_EXIT_AND_PATCH = 5
ACT_RESOLVE_MOVEMENT = 6
ACT_PRINT_EH = 7
ACT_PRINT_WHERE_I_CANT_SEE_IT = 8
ACT_TRY_GET_CURRENT_OBJECT = 9
ACT_DROP_CURRENT_OBJECT = 10
ACT_PRINT_IT_WONT_OPEN = 11
ACT_USE_KEY_FOREST = 12
ACT_USE_KEY_TEMPLE = 13
ACT_PRINT_NOTHING_TO_KILL = 14
ACT_SWORD_COMBAT = 15
ACT_USE_BOMB = 16
ACT_PRINT_TOO_DANGEROUS = 17
ACT_USE_ROPE = 18
ACT_PRINT_PATTERN_RESPONSE = 19
ACT_SET_BRIDGE_FATAL_AND_PATCH = 20
ACT_SET_HUT_VISITED = 21
ACT_ENABLE_WATER_EXIT_AND_PATCH = 22
ACT_DISABLE_WATER_EXIT_AND_PATCH = 23
ACT_SET_GATE_DEST_AND_PATCH = 24
ACT_SET_DRAWBRIDGE_AND_PATCH = 25
ACT_BAT_CARRY = 26
ACT_NOOP = 27
ACT_MONSTER_ATTACK_AND_KILL = 28
ACT_DESCRIBE_LIT = 29
ACT_DESCRIBE_DARK = 30
ACT_CLEAR_GATE_DEST_AND_PATCH = 31
ACT_CLEAR_DRAWBRIDGE_AND_PATCH = 32
ACT_CLEAR_TELEPORT_DEST_AND_PATCH = 33
ACT_CLEAR_SECRET_EXIT_AND_PATCH = 34


RULE_COUNT = 0
dim RULE_PHASE(128)
dim RULE_GPTR(128)
dim RULE_ACT(128)

dim GUARD_DATA(2048)

gosub BUILD_RULE_TABLE_SUB


DATA_DRIVEN_START:
    gosub INIT_STATE_SUB

MAIN_LOOP:
    if PLAYER_ALIVE = 0 then
        gosub ACT_QUIT_AND_SCORE_SUB
        end
    end if

    gosub READ_INPUT_AND_PARSE_SUB
    gosub UPDATE_HOSTILE_SUB

    CURRENT_PHASE = PHASE_ON_COMMAND
    gosub RUN_PHASE_SUB

    if FLAGS(FLAG_PLAYER_MOVED) = 1 then
        FLAGS(FLAG_PLAYER_MOVED) = 0
        CURRENT_PHASE = PHASE_ON_ENTER
        gosub RUN_PHASE_SUB
    end if

    CURRENT_PHASE = PHASE_DESCRIBE
    gosub RUN_PHASE_SUB

    goto MAIN_LOOP


RUN_PHASE_SUB:
    for RULE_I = 0 to RULE_COUNT-1
        if RULE_PHASE(RULE_I) <> CURRENT_PHASE then
            goto NEXT_RULE
        end if
        GUARD_PTR = RULE_GPTR(RULE_I)
        gosub EVAL_GUARDS_SUB
        if GUARDS_PASS = 1 then
            ACTION_ID = RULE_ACT(RULE_I)
            gosub DISPATCH_ACTION_SUB
            return
        end if
NEXT_RULE:
    next RULE_I
    return

EVAL_GUARDS_SUB:
    GUARDS_PASS = 0
    BOOL_MODE = G_AND
    ACC = 1
EVAL_LOOP:
    OPCODE = GUARD_DATA(GUARD_PTR): GUARD_PTR = GUARD_PTR + 1
    OPA    = GUARD_DATA(GUARD_PTR): GUARD_PTR = GUARD_PTR + 1
    OPB    = GUARD_DATA(GUARD_PTR): GUARD_PTR = GUARD_PTR + 1

    if OPCODE = G_END then
        GUARDS_PASS = ACC
        return
    end if
    if OPCODE = G_AND then
        BOOL_MODE = G_AND
        goto EVAL_LOOP
    end if
    if OPCODE = G_OR then
        BOOL_MODE = G_OR
        goto EVAL_LOOP
    end if

    NOTBIT = 0
    if OPCODE >= 128 then
        NOTBIT = 1
        OPCODE = OPCODE - 128
    end if

    gosub EVAL_ATOMIC_GUARD_SUB
    RES = ATOMIC_RESULT
    if NOTBIT = 1 then
        if RES = 1 then RES = 0 else RES = 1
    end if

    if BOOL_MODE = G_AND then
        if ACC = 1 and RES = 1 then
            ACC = 1
        else
            GUARDS_PASS = 0
            return
        end if
    else
        if ACC = 1 or RES = 1 then
            GUARDS_PASS = 1
            return
        end if
    end if

    goto EVAL_LOOP

EVAL_ATOMIC_GUARD_SUB:
    ATOMIC_RESULT = 0
    if OPCODE = G_AT then
        if PLAYER_LOCATION = OPA then ATOMIC_RESULT = 1
        return
    end if
    if OPCODE = G_ROOM_LT then
        if PLAYER_LOCATION < OPA then ATOMIC_RESULT = 1
        return
    end if
    if OPCODE = G_FLAG_EQ then
        if FLAGS(OPA) = OPB then ATOMIC_RESULT = 1
        return
    end if
    if OPCODE = G_FLAG_NE then
        if FLAGS(OPA) <> OPB then ATOMIC_RESULT = 1
        return
    end if
    if OPCODE = G_ENT_AT_ROOM then
        if ENTITY_LOCATION(OPA) = OPB then ATOMIC_RESULT = 1
        return
    end if
    if OPCODE = G_ENT_AT_PLAYER then
        if ENTITY_LOCATION(OPA) = PLAYER_LOCATION then ATOMIC_RESULT = 1
        return
    end if
    if OPCODE = G_ENT_CARRIED then
        if ENTITY_LOCATION(OPA) = ENT_LOC_CARRIED then ATOMIC_RESULT = 1
        return
    end if
    if OPCODE = G_ENT_VISIBLE then
        if ENTITY_LOCATION(OPA) = ENT_LOC_CARRIED or ENTITY_LOCATION(OPA) = PLAYER_LOCATION then ATOMIC_RESULT = 1
        return
    end if
    if OPCODE = G_ENT_VISIBLE_CURRENT then
        ENT = FLAGS(OPA)
        if ENT <> 0 then
            if ENTITY_LOCATION(ENT) = ENT_LOC_CARRIED or ENTITY_LOCATION(ENT) = PLAYER_LOCATION then ATOMIC_RESULT = 1
        end if
        return
    end if
    return


DISPATCH_ACTION_SUB:
    select case ACTION_ID
        case ACT_FORCE_REDESCRIBE: gosub ACT_FORCE_REDESCRIBE_SUB
        case ACT_PRINT_INVENTORY: gosub ACT_PRINT_INVENTORY_SUB
        case ACT_QUIT_AND_SCORE: gosub ACT_QUIT_AND_SCORE_SUB
        case ACT_TELEPORT_TO_CAVE_ENTRY: gosub ACT_TELEPORT_TO_CAVE_ENTRY_SUB
        case ACT_OPEN_CRYPT_SECRET_EXIT_AND_PATCH: gosub ACT_OPEN_CRYPT_SECRET_EXIT_AND_PATCH_SUB
        case ACT_RESOLVE_MOVEMENT: gosub ACT_RESOLVE_MOVEMENT_SUB
        case ACT_PRINT_EH: gosub ACT_PRINT_EH_SUB
        case ACT_PRINT_WHERE_I_CANT_SEE_IT: gosub ACT_PRINT_WHERE_I_CANT_SEE_IT_SUB
        case ACT_TRY_GET_CURRENT_OBJECT: gosub ACT_TRY_GET_CURRENT_OBJECT_SUB
        case ACT_DROP_CURRENT_OBJECT: gosub ACT_DROP_CURRENT_OBJECT_SUB
        case ACT_PRINT_IT_WONT_OPEN: gosub ACT_PRINT_IT_WONT_OPEN_SUB
        case ACT_USE_KEY_FOREST: gosub ACT_USE_KEY_FOREST_SUB
        case ACT_USE_KEY_TEMPLE: gosub ACT_USE_KEY_TEMPLE_SUB
        case ACT_PRINT_NOTHING_TO_KILL: gosub ACT_PRINT_NOTHING_TO_KILL_SUB
        case ACT_SWORD_COMBAT: gosub ACT_SWORD_COMBAT_SUB
        case ACT_USE_BOMB: gosub ACT_USE_BOMB_SUB
        case ACT_PRINT_TOO_DANGEROUS: gosub ACT_PRINT_TOO_DANGEROUS_SUB
        case ACT_USE_ROPE: gosub ACT_USE_ROPE_SUB
        case ACT_PRINT_PATTERN_RESPONSE: gosub ACT_PRINT_PATTERN_RESPONSE_SUB
        case ACT_SET_BRIDGE_FATAL_AND_PATCH: gosub ACT_SET_BRIDGE_FATAL_AND_PATCH_SUB
        case ACT_SET_HUT_VISITED: gosub ACT_SET_HUT_VISITED_SUB
        case ACT_ENABLE_WATER_EXIT_AND_PATCH: gosub ACT_ENABLE_WATER_EXIT_AND_PATCH_SUB
        case ACT_DISABLE_WATER_EXIT_AND_PATCH: gosub ACT_DISABLE_WATER_EXIT_AND_PATCH_SUB
        case ACT_SET_GATE_DEST_AND_PATCH: gosub ACT_SET_GATE_DEST_AND_PATCH_SUB
        case ACT_CLEAR_GATE_DEST_AND_PATCH: gosub ACT_CLEAR_GATE_DEST_AND_PATCH_SUB
        case ACT_SET_DRAWBRIDGE_AND_PATCH: gosub ACT_SET_DRAWBRIDGE_AND_PATCH_SUB
        case ACT_CLEAR_DRAWBRIDGE_AND_PATCH: gosub ACT_CLEAR_DRAWBRIDGE_AND_PATCH_SUB
        case ACT_CLEAR_TELEPORT_DEST_AND_PATCH: gosub ACT_CLEAR_TELEPORT_DEST_AND_PATCH_SUB
        case ACT_CLEAR_SECRET_EXIT_AND_PATCH: gosub ACT_CLEAR_SECRET_EXIT_AND_PATCH_SUB
        case ACT_BAT_CARRY: gosub ACT_BAT_CARRY_SUB
        case ACT_NOOP: gosub ACT_NOOP_SUB
        case ACT_MONSTER_ATTACK_AND_KILL: gosub ACT_MONSTER_ATTACK_AND_KILL_SUB
        case ACT_DESCRIBE_LIT: gosub ACT_DESCRIBE_LIT_SUB
        case ACT_DESCRIBE_DARK: gosub ACT_DESCRIBE_DARK_SUB
    end select
    return


ADD_RULE_SUB:
    RULE_PHASE(RULE_COUNT) = RULE_PHASE_TMP
    RULE_GPTR(RULE_COUNT)  = RULE_GPTR_TMP
    RULE_ACT(RULE_COUNT)   = RULE_ACT_TMP
    RULE_COUNT = RULE_COUNT + 1
    return

BUILD_RULE_TABLE_SUB:
    gosub BUILD_GUARDS_SUB

    RULE_PHASE_TMP=PHASE_ON_COMMAND: RULE_GPTR_TMP=GP_SPECIAL_LOOK: RULE_ACT_TMP=ACT_FORCE_REDESCRIBE: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_ON_COMMAND: RULE_GPTR_TMP=GP_SPECIAL_LIST: RULE_ACT_TMP=ACT_PRINT_INVENTORY: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_ON_COMMAND: RULE_GPTR_TMP=GP_SPECIAL_QUIT: RULE_ACT_TMP=ACT_QUIT_AND_SCORE: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_ON_COMMAND: RULE_GPTR_TMP=GP_SPECIAL_GALAR: RULE_ACT_TMP=ACT_TELEPORT_TO_CAVE_ENTRY: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_ON_COMMAND: RULE_GPTR_TMP=GP_SPECIAL_APE: RULE_ACT_TMP=ACT_OPEN_CRYPT_SECRET_EXIT_AND_PATCH: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_ON_COMMAND: RULE_GPTR_TMP=GP_HAS_DIR: RULE_ACT_TMP=ACT_RESOLVE_MOVEMENT: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_ON_COMMAND: RULE_GPTR_TMP=GP_NO_OBJECT: RULE_ACT_TMP=ACT_PRINT_EH: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_ON_COMMAND: RULE_GPTR_TMP=GP_OBJ_NOT_VISIBLE: RULE_ACT_TMP=ACT_PRINT_WHERE_I_CANT_SEE_IT: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_ON_COMMAND: RULE_GPTR_TMP=GP_VERB_GET: RULE_ACT_TMP=ACT_TRY_GET_CURRENT_OBJECT: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_ON_COMMAND: RULE_GPTR_TMP=GP_VERB_DROP: RULE_ACT_TMP=ACT_DROP_CURRENT_OBJECT: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_ON_COMMAND: RULE_GPTR_TMP=GP_USE_KEY_BAD: RULE_ACT_TMP=ACT_PRINT_IT_WONT_OPEN: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_ON_COMMAND: RULE_GPTR_TMP=GP_USE_KEY_FOREST: RULE_ACT_TMP=ACT_USE_KEY_FOREST: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_ON_COMMAND: RULE_GPTR_TMP=GP_USE_KEY_TEMPLE: RULE_ACT_TMP=ACT_USE_KEY_TEMPLE: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_ON_COMMAND: RULE_GPTR_TMP=GP_USE_SWORD_NOHOST: RULE_ACT_TMP=ACT_PRINT_NOTHING_TO_KILL: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_ON_COMMAND: RULE_GPTR_TMP=GP_USE_SWORD_HOST: RULE_ACT_TMP=ACT_SWORD_COMBAT: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_ON_COMMAND: RULE_GPTR_TMP=GP_USE_BOMB: RULE_ACT_TMP=ACT_USE_BOMB: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_ON_COMMAND: RULE_GPTR_TMP=GP_USE_ROPE_BAD: RULE_ACT_TMP=ACT_PRINT_TOO_DANGEROUS: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_ON_COMMAND: RULE_GPTR_TMP=GP_USE_ROPE_OK: RULE_ACT_TMP=ACT_USE_ROPE: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_ON_COMMAND: RULE_GPTR_TMP=GP_PATTERN_RESP: RULE_ACT_TMP=ACT_PRINT_PATTERN_RESPONSE: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_ON_COMMAND: RULE_GPTR_TMP=GP_ALWAYS: RULE_ACT_TMP=ACT_PRINT_EH: gosub ADD_RULE_SUB

    RULE_PHASE_TMP=PHASE_ON_ENTER: RULE_GPTR_TMP=GP_AT_BRIDGE_MID: RULE_ACT_TMP=ACT_SET_BRIDGE_FATAL_AND_PATCH: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_ON_ENTER: RULE_GPTR_TMP=GP_AT_FOREST_CLEARING: RULE_ACT_TMP=ACT_SET_HUT_VISITED: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_ON_ENTER: RULE_GPTR_TMP=GP_AT_WATERFALL_BASE: RULE_ACT_TMP=ACT_ENABLE_WATER_EXIT_AND_PATCH: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_ON_ENTER: RULE_GPTR_TMP=GP_AT_TEMPLE: RULE_ACT_TMP=ACT_DISABLE_WATER_EXIT_AND_PATCH: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_ON_ENTER: RULE_GPTR_TMP=GP_GRILL_NOT_TINY: RULE_ACT_TMP=ACT_SET_GATE_DEST_AND_PATCH: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_ON_ENTER: RULE_GPTR_TMP=GP_GRILL_IN_TINY: RULE_ACT_TMP=ACT_CLEAR_GATE_DEST_AND_PATCH: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_ON_ENTER: RULE_GPTR_TMP=GP_AT_DRAWBRIDGE: RULE_ACT_TMP=ACT_SET_DRAWBRIDGE_AND_PATCH: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_ON_ENTER: RULE_GPTR_TMP=GP_NOT_AT_DRAWBRIDGE: RULE_ACT_TMP=ACT_CLEAR_DRAWBRIDGE_AND_PATCH: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_ON_ENTER: RULE_GPTR_TMP=GP_AT_OAK_DOOR: RULE_ACT_TMP=ACT_NOOP: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_ON_ENTER: RULE_GPTR_TMP=GP_NOT_AT_OAK_DOOR: RULE_ACT_TMP=ACT_CLEAR_TELEPORT_DEST_AND_PATCH: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_ON_ENTER: RULE_GPTR_TMP=GP_AT_CRYPT: RULE_ACT_TMP=ACT_NOOP: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_ON_ENTER: RULE_GPTR_TMP=GP_NOT_AT_CRYPT: RULE_ACT_TMP=ACT_CLEAR_SECRET_EXIT_AND_PATCH: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_ON_ENTER: RULE_GPTR_TMP=GP_BAT_PRESENT: RULE_ACT_TMP=ACT_BAT_CARRY: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_ON_ENTER: RULE_GPTR_TMP=GP_ALWAYS: RULE_ACT_TMP=ACT_NOOP: gosub ADD_RULE_SUB

    RULE_PHASE_TMP=PHASE_DESCRIBE: RULE_GPTR_TMP=GP_HOSTILE_ATTACK: RULE_ACT_TMP=ACT_MONSTER_ATTACK_AND_KILL: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_DESCRIBE: RULE_GPTR_TMP=GP_BRIGHT_ROOM: RULE_ACT_TMP=ACT_DESCRIBE_LIT: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_DESCRIBE: RULE_GPTR_TMP=GP_BRIGHT_CANDLE: RULE_ACT_TMP=ACT_DESCRIBE_LIT: gosub ADD_RULE_SUB
    RULE_PHASE_TMP=PHASE_DESCRIBE: RULE_GPTR_TMP=GP_ALWAYS: RULE_ACT_TMP=ACT_DESCRIBE_DARK: gosub ADD_RULE_SUB
    return

BUILD_GUARDS_SUB:
    GD = 0

    GP_ALWAYS = GD: GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3

    GP_SPECIAL_LOOK = GD: GUARD_DATA(GD)=G_FLAG_EQ:GUARD_DATA(GD+1)=FLAG_SPECIAL_WORD:GUARD_DATA(GD+2)=SPECIAL_LOOK: GD=GD+3: GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3
    GP_SPECIAL_LIST = GD: GUARD_DATA(GD)=G_FLAG_EQ:GUARD_DATA(GD+1)=FLAG_SPECIAL_WORD:GUARD_DATA(GD+2)=SPECIAL_LIST: GD=GD+3: GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3
    GP_SPECIAL_QUIT = GD: GUARD_DATA(GD)=G_FLAG_EQ:GUARD_DATA(GD+1)=FLAG_SPECIAL_WORD:GUARD_DATA(GD+2)=SPECIAL_QUIT: GD=GD+3: GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3
    GP_SPECIAL_GALAR = GD: GUARD_DATA(GD)=G_FLAG_EQ:GUARD_DATA(GD+1)=FLAG_SPECIAL_WORD:GUARD_DATA(GD+2)=SPECIAL_GALAR: GD=GD+3: GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3
    GP_SPECIAL_APE = GD: GUARD_DATA(GD)=G_FLAG_EQ:GUARD_DATA(GD+1)=FLAG_SPECIAL_WORD:GUARD_DATA(GD+2)=SPECIAL_APE: GD=GD+3: GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3

    GP_HAS_DIR = GD: GUARD_DATA(GD)=G_FLAG_NE:GUARD_DATA(GD+1)=FLAG_CURRENT_DIR:GUARD_DATA(GD+2)=255: GD=GD+3: GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3
    GP_NO_OBJECT = GD: GUARD_DATA(GD)=G_FLAG_EQ:GUARD_DATA(GD+1)=FLAG_CURRENT_OBJECT:GUARD_DATA(GD+2)=0: GD=GD+3: GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3
    GP_OBJ_NOT_VISIBLE = GD: GUARD_DATA(GD)=G_FLAG_NE:GUARD_DATA(GD+1)=FLAG_CURRENT_OBJECT:GUARD_DATA(GD+2)=0: GD=GD+3: GUARD_DATA(GD)=128+G_ENT_VISIBLE_CURRENT:GUARD_DATA(GD+1)=FLAG_CURRENT_OBJECT:GUARD_DATA(GD+2)=0: GD=GD+3: GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3

    GP_VERB_GET = GD: GUARD_DATA(GD)=G_FLAG_EQ:GUARD_DATA(GD+1)=FLAG_CURRENT_VERB:GUARD_DATA(GD+2)=VERB_GET: GD=GD+3: GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3
    GP_VERB_DROP = GD: GUARD_DATA(GD)=G_FLAG_EQ:GUARD_DATA(GD+1)=FLAG_CURRENT_VERB:GUARD_DATA(GD+2)=VERB_DROP: GD=GD+3: GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3

    GP_USE_KEY_BAD = GD
    GUARD_DATA(GD)=G_FLAG_EQ:GUARD_DATA(GD+1)=FLAG_CURRENT_VERB:GUARD_DATA(GD+2)=VERB_USE: GD=GD+3
    GUARD_DATA(GD)=G_FLAG_EQ:GUARD_DATA(GD+1)=FLAG_CURRENT_OBJECT:GUARD_DATA(GD+2)=OBJ_KEY: GD=GD+3
    GUARD_DATA(GD)=128+G_AT:GUARD_DATA(GD+1)=ROOM_FOREST_CLEARING:GUARD_DATA(GD+2)=0: GD=GD+3
    GUARD_DATA(GD)=128+G_AT:GUARD_DATA(GD+1)=ROOM_TEMPLE:GUARD_DATA(GD+2)=0: GD=GD+3
    GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3

    GP_USE_KEY_FOREST = GD
    GUARD_DATA(GD)=G_FLAG_EQ:GUARD_DATA(GD+1)=FLAG_CURRENT_VERB:GUARD_DATA(GD+2)=VERB_USE: GD=GD+3
    GUARD_DATA(GD)=G_FLAG_EQ:GUARD_DATA(GD+1)=FLAG_CURRENT_OBJECT:GUARD_DATA(GD+2)=OBJ_KEY: GD=GD+3
    GUARD_DATA(GD)=G_AT:GUARD_DATA(GD+1)=ROOM_FOREST_CLEARING:GUARD_DATA(GD+2)=0: GD=GD+3
    GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3

    GP_USE_KEY_TEMPLE = GD
    GUARD_DATA(GD)=G_FLAG_EQ:GUARD_DATA(GD+1)=FLAG_CURRENT_VERB:GUARD_DATA(GD+2)=VERB_USE: GD=GD+3
    GUARD_DATA(GD)=G_FLAG_EQ:GUARD_DATA(GD+1)=FLAG_CURRENT_OBJECT:GUARD_DATA(GD+2)=OBJ_KEY: GD=GD+3
    GUARD_DATA(GD)=G_AT:GUARD_DATA(GD+1)=ROOM_TEMPLE:GUARD_DATA(GD+2)=0: GD=GD+3
    GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3

    GP_USE_SWORD_NOHOST = GD
    GUARD_DATA(GD)=G_FLAG_EQ:GUARD_DATA(GD+1)=FLAG_CURRENT_VERB:GUARD_DATA(GD+2)=VERB_USE: GD=GD+3
    GUARD_DATA(GD)=G_FLAG_EQ:GUARD_DATA(GD+1)=FLAG_CURRENT_OBJECT:GUARD_DATA(GD+2)=OBJ_SWORD: GD=GD+3
    GUARD_DATA(GD)=G_FLAG_EQ:GUARD_DATA(GD+1)=FLAG_HOSTILE_CREATURE_INDEX:GUARD_DATA(GD+2)=0: GD=GD+3
    GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3

    GP_USE_SWORD_HOST = GD
    GUARD_DATA(GD)=G_FLAG_EQ:GUARD_DATA(GD+1)=FLAG_CURRENT_VERB:GUARD_DATA(GD+2)=VERB_USE: GD=GD+3
    GUARD_DATA(GD)=G_FLAG_EQ:GUARD_DATA(GD+1)=FLAG_CURRENT_OBJECT:GUARD_DATA(GD+2)=OBJ_SWORD: GD=GD+3
    GUARD_DATA(GD)=G_FLAG_NE:GUARD_DATA(GD+1)=FLAG_HOSTILE_CREATURE_INDEX:GUARD_DATA(GD+2)=0: GD=GD+3
    GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3

    GP_USE_BOMB = GD
    GUARD_DATA(GD)=G_FLAG_EQ:GUARD_DATA(GD+1)=FLAG_CURRENT_VERB:GUARD_DATA(GD+2)=VERB_USE: GD=GD+3
    GUARD_DATA(GD)=G_FLAG_EQ:GUARD_DATA(GD+1)=FLAG_CURRENT_OBJECT:GUARD_DATA(GD+2)=OBJ_CANDLE: GD=GD+3
    GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3

    GP_USE_ROPE_BAD = GD
    GUARD_DATA(GD)=G_FLAG_EQ:GUARD_DATA(GD+1)=FLAG_CURRENT_VERB:GUARD_DATA(GD+2)=VERB_USE: GD=GD+3
    GUARD_DATA(GD)=G_FLAG_EQ:GUARD_DATA(GD+1)=FLAG_CURRENT_OBJECT:GUARD_DATA(GD+2)=OBJ_ROPE: GD=GD+3
    GUARD_DATA(GD)=128+G_AT:GUARD_DATA(GD+1)=ROOM_TEMPLE_BALCONY:GUARD_DATA(GD+2)=0: GD=GD+3
    GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3

    GP_USE_ROPE_OK = GD
    GUARD_DATA(GD)=G_FLAG_EQ:GUARD_DATA(GD+1)=FLAG_CURRENT_VERB:GUARD_DATA(GD+2)=VERB_USE: GD=GD+3
    GUARD_DATA(GD)=G_FLAG_EQ:GUARD_DATA(GD+1)=FLAG_CURRENT_OBJECT:GUARD_DATA(GD+2)=OBJ_ROPE: GD=GD+3
    GUARD_DATA(GD)=G_AT:GUARD_DATA(GD+1)=ROOM_TEMPLE_BALCONY:GUARD_DATA(GD+2)=0: GD=GD+3
    GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3

    GP_PATTERN_RESP = GD
    GUARD_DATA(GD)=G_FLAG_NE:GUARD_DATA(GD+1)=FLAG_VERB_PATTERN_INDEX:GUARD_DATA(GD+2)=0: GD=GD+3
    GUARD_DATA(GD)=G_FLAG_EQ:GUARD_DATA(GD+1)=FLAG_CURRENT_VERB:GUARD_DATA(GD+2)=VERB_NONE: GD=GD+3
    GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3

    GP_AT_BRIDGE_MID = GD: GUARD_DATA(GD)=G_AT:GUARD_DATA(GD+1)=ROOM_BRIDGE_MID:GUARD_DATA(GD+2)=0: GD=GD+3: GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3
    GP_AT_FOREST_CLEARING = GD: GUARD_DATA(GD)=G_AT:GUARD_DATA(GD+1)=ROOM_FOREST_CLEARING:GUARD_DATA(GD+2)=0: GD=GD+3: GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3
    GP_AT_WATERFALL_BASE = GD: GUARD_DATA(GD)=G_AT:GUARD_DATA(GD+1)=ROOM_WATERFALL_BASE:GUARD_DATA(GD+2)=0: GD=GD+3: GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3
    GP_AT_TEMPLE = GD: GUARD_DATA(GD)=G_AT:GUARD_DATA(GD+1)=ROOM_TEMPLE:GUARD_DATA(GD+2)=0: GD=GD+3: GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3
    GP_AT_DRAWBRIDGE = GD: GUARD_DATA(GD)=G_AT:GUARD_DATA(GD+1)=ROOM_DRAWBRIDGE:GUARD_DATA(GD+2)=0: GD=GD+3: GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3
    GP_NOT_AT_DRAWBRIDGE = GD: GUARD_DATA(GD)=128+G_AT:GUARD_DATA(GD+1)=ROOM_DRAWBRIDGE:GUARD_DATA(GD+2)=0: GD=GD+3: GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3
    GP_AT_OAK_DOOR = GD: GUARD_DATA(GD)=G_AT:GUARD_DATA(GD+1)=ROOM_OAK_DOOR:GUARD_DATA(GD+2)=0: GD=GD+3: GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3
    GP_NOT_AT_OAK_DOOR = GD: GUARD_DATA(GD)=128+G_AT:GUARD_DATA(GD+1)=ROOM_OAK_DOOR:GUARD_DATA(GD+2)=0: GD=GD+3: GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3
    GP_AT_CRYPT = GD: GUARD_DATA(GD)=G_AT:GUARD_DATA(GD+1)=ROOM_CRYPT:GUARD_DATA(GD+2)=0: GD=GD+3: GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3
    GP_NOT_AT_CRYPT = GD: GUARD_DATA(GD)=128+G_AT:GUARD_DATA(GD+1)=ROOM_CRYPT:GUARD_DATA(GD+2)=0: GD=GD+3: GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3
    GP_GRILL_NOT_TINY = GD: GUARD_DATA(GD)=128+G_ENT_AT_ROOM:GUARD_DATA(GD+1)=OBJ_GRILL:GUARD_DATA(GD+2)=ROOM_TINY_CELL: GD=GD+3: GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3
    GP_GRILL_IN_TINY = GD: GUARD_DATA(GD)=G_ENT_AT_ROOM:GUARD_DATA(GD+1)=OBJ_GRILL:GUARD_DATA(GD+2)=ROOM_TINY_CELL: GD=GD+3: GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3
    GP_BAT_PRESENT = GD: GUARD_DATA(GD)=G_ENT_AT_PLAYER:GUARD_DATA(GD+1)=ENT_BAT:GUARD_DATA(GD+2)=0: GD=GD+3: GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3

    GP_HOSTILE_ATTACK = GD
    GUARD_DATA(GD)=G_FLAG_NE:GUARD_DATA(GD+1)=FLAG_HOSTILE_CREATURE_INDEX:GUARD_DATA(GD+2)=0: GD=GD+3
    GUARD_DATA(GD)=G_FLAG_NE:GUARD_DATA(GD+1)=FLAG_HOSTILE_CREATURE_INDEX:GUARD_DATA(GD+2)=ENT_BAT: GD=GD+3
    GUARD_DATA(GD)=G_FLAG_NE:GUARD_DATA(GD+1)=FLAG_CURRENT_OBJECT:GUARD_DATA(GD+2)=OBJ_SWORD: GD=GD+3
    GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3

    GP_BRIGHT_ROOM = GD: GUARD_DATA(GD)=G_ROOM_LT:GUARD_DATA(GD+1)=ROOM_DARK_CAVERN_A:GUARD_DATA(GD+2)=0: GD=GD+3: GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3
    GP_BRIGHT_CANDLE = GD
    GUARD_DATA(GD)=G_FLAG_EQ:GUARD_DATA(GD+1)=FLAG_CANDLE_LIT:GUARD_DATA(GD+2)=1: GD=GD+3
    GUARD_DATA(GD)=G_ENT_VISIBLE:GUARD_DATA(GD+1)=OBJ_CANDLE:GUARD_DATA(GD+2)=0: GD=GD+3
    GUARD_DATA(GD)=G_END:GUARD_DATA(GD+1)=0:GUARD_DATA(GD+2)=0: GD=GD+3
    return


INIT_STATE_SUB:
    MOVEMENT_TABLE = MOVEMENT_TABLE_DATA
    ROOM_DESC1_PTR = ROOM_DESC1_PTR
    ROOM_DESC2_PTR = ROOM_DESC2_PTR
    OBJECT_NAME_ADJ = OBJECT_NAME_ADJ_DATA
    OBJECT_NAME_NOUN = OBJECT_NAME_NOUN_DATA
    MONSTER_ADJ = MONSTER_ADJ_DATA
    MONSTER_NOUN = MONSTER_NOUN_DATA
    VERB_PATTERN = VERB_PATTERN_DATA
    DIR_WORD_INDEX = DIR_WORD_INDEX_DATA
    OBJDESC1 = OBJDESC1_DATA
    OBJDESC2 = OBJDESC2_DATA

    ENTITY_LOCATION = OBJECT_LOCATION_DATA

    PLAYER_ALIVE = 1
    PLAYER_LOCATION = ROOM_DARK_ROOM
    TURN_COUNTER = 0
    FLAGS(FLAG_PLAYER_MOVED) = 0

    FLAGS(FLAG_BRIDGE_CONDITION) = ROOM_BRIDGE_MID
    FLAGS(FLAG_DRAWBRIDGE_STATE) = EXIT_FATAL
    FLAGS(FLAG_WATER_EXIT_LOCATION) = 0
    FLAGS(FLAG_GATE_DESTINATION) = 0
    FLAGS(FLAG_TELEPORT_DESTINATION) = 0
    FLAGS(FLAG_SECRET_EXIT_LOCATION) = 0

    FLAGS(FLAG_HUT_VISITED) = 0
    FLAGS(FLAG_HOSTILE_CREATURE_INDEX) = 0
    FLAGS(FLAG_CANDLE_LIT) = 1
    FLAGS(FLAG_SWORD_SWING_COUNT) = 0
    FLAGS(FLAG_SCORE) = 0

    gosub ACT_PATCH_DYNAMIC_EXITS_SUB
    return

READ_INPUT_AND_PARSE_SUB:
    input INPUT_COMMAND$
    if INPUT_COMMAND$ = "" then
        goto READ_INPUT_AND_PARSE_SUB
    end if

    INPUT_COMMAND$ = " " + INPUT_COMMAND$ + " "
    TURN_COUNTER = TURN_COUNTER + 1

    gosub NORMALIZE_INPUT_SUB

    FLAGS(FLAG_SPECIAL_WORD) = SPECIAL_NONE
    FLAGS(FLAG_CURRENT_VERB) = VERB_NONE
    FLAGS(FLAG_CURRENT_DIR) = 255
    FLAGS(FLAG_CURRENT_OBJECT) = 0
    FLAGS(FLAG_VERB_PATTERN_INDEX) = 0

    if INSTR(INPUT_COMMAND$, " look ") > 0 then FLAGS(FLAG_SPECIAL_WORD) = SPECIAL_LOOK
    if INSTR(INPUT_COMMAND$, " list ") > 0 then FLAGS(FLAG_SPECIAL_WORD) = SPECIAL_LIST
    if INSTR(INPUT_COMMAND$, " quit ") > 0 then FLAGS(FLAG_SPECIAL_WORD) = SPECIAL_QUIT
    if INSTR(INPUT_COMMAND$, " galar ") > 0 then FLAGS(FLAG_SPECIAL_WORD) = SPECIAL_GALAR
    if INSTR(INPUT_COMMAND$, " ape ") > 0 then FLAGS(FLAG_SPECIAL_WORD) = SPECIAL_APE

    if INSTR(INPUT_COMMAND$, " get ") > 0 then FLAGS(FLAG_CURRENT_VERB) = VERB_GET
    if INSTR(INPUT_COMMAND$, " drop ") > 0 then FLAGS(FLAG_CURRENT_VERB) = VERB_DROP
    if INSTR(INPUT_COMMAND$, " use ") > 0 then FLAGS(FLAG_CURRENT_VERB) = VERB_USE

    for DIRECTION_INDEX = 0 to 3
        if INSTR(INPUT_COMMAND$, @DIR_WORD_INDEX(DIRECTION_INDEX+1)) > 0 then
            FLAGS(FLAG_CURRENT_DIR) = DIRECTION_INDEX
            EXIT for
        end if
    next DIRECTION_INDEX

    for VERB_PATTERN_INDEX = 1 to 16
        if INSTR(INPUT_COMMAND$, @VERB_PATTERN(VERB_PATTERN_INDEX)) > 0 then
            FLAGS(FLAG_VERB_PATTERN_INDEX) = VERB_PATTERN_INDEX
            if FLAGS(FLAG_CURRENT_VERB) = VERB_NONE then
                select case VERB_PATTERN_INDEX
                    case 1
                        FLAGS(FLAG_CURRENT_VERB) = VERB_GET
                    case 2
                        FLAGS(FLAG_CURRENT_VERB) = VERB_DROP
                    case 3,4
                        FLAGS(FLAG_CURRENT_VERB) = VERB_USE
                end select
            end if
            EXIT for
        end if
    next VERB_PATTERN_INDEX

    for LOOP_INDEX = 7 to 24
        OBJECT_NOUN$ = @OBJECT_NAME_NOUN(LOOP_INDEX)
        if INSTR(INPUT_COMMAND$, OBJECT_NOUN$) > 0 then
            FLAGS(FLAG_CURRENT_OBJECT) = LOOP_INDEX
            EXIT for
        end if
    next LOOP_INDEX

    return

UPDATE_HOSTILE_SUB:
    FLAGS(FLAG_HOSTILE_CREATURE_INDEX) = 0
    for I=1 to 6
        if ENTITY_LOCATION(I) = PLAYER_LOCATION then
            FLAGS(FLAG_HOSTILE_CREATURE_INDEX) = I
            return
        end if
    next I
    return

ACT_NOOP_SUB: return
ACT_FORCE_REDESCRIBE_SUB:
    return

ACT_PRINT_EH_SUB:
    print "eh?"
    return

ACT_PRINT_WHERE_I_CANT_SEE_IT_SUB:
    print "Where? I can't see it."
    return

ACT_PRINT_TOO_DANGEROUS_SUB:
    print "It's too dangerous!!!"
    return

ACT_PRINT_IT_WONT_OPEN_SUB:
    print "It won't open!"
    return

ACT_PRINT_NOTHING_TO_KILL_SUB:
    print "But there's nothing to kill..."
    return

ACT_PRINT_PATTERN_RESPONSE_SUB:
    select case FLAGS(FLAG_VERB_PATTERN_INDEX)
        case 5,6
            print "Nothing happens!"
        case 7 to 12
            print "Please tell me how."
        case else
            print "I can't!"
    end select
    return

ACT_PRINT_INVENTORY_SUB:
    print "You are carrying ";
    CARRIED_COUNT = 0
    for LOOP_INDEX = 7 to 24
        if ENTITY_LOCATION(LOOP_INDEX) = ENT_LOC_CARRIED then
            CARRIED_COUNT = CARRIED_COUNT + 1
        end if
    next LOOP_INDEX
    if CARRIED_COUNT = 0 then
        print "nothing."
        return
    end if
    print
    for LOOP_INDEX = 7 to 24
        if ENTITY_LOCATION(LOOP_INDEX) = ENT_LOC_CARRIED then
            CURRENT_OBJECT_INDEX = LOOP_INDEX
            gosub PRINT_OBJECT_DESCRIPTION_SUB
        end if
    next LOOP_INDEX
    return

ACT_QUIT_AND_SCORE_SUB:
    SCORE = 0
    for LOOP_INDEX = 7 to 17
        if ENTITY_LOCATION(LOOP_INDEX) = ENT_LOC_CARRIED then
            SCORE = SCORE + LOOP_INDEX - 6
        end if
        if ENTITY_LOCATION(LOOP_INDEX) = 1 then
            SCORE = SCORE + (LOOP_INDEX - 6) * 2
        end if
    next LOOP_INDEX
    FLAGS(FLAG_SCORE) = SCORE
    print
    print "You have a score of"; SCORE; " out of a possible 126 points in"; TURN_COUNTER; " moves."
    gosub PRINT_RANKING_SUB
    print "Another adventure? ";
    PLAYER_ALIVE = 0
    return

ACT_TELEPORT_TO_CAVE_ENTRY_SUB:
    print "Suddenly a magic wind carried you to another place..."
    PLAYER_LOCATION = ROOM_CAVE_ENTRY
    FLAGS(FLAG_PLAYER_MOVED) = 1
    return

ACT_OPEN_CRYPT_SECRET_EXIT_AND_PATCH_SUB:
    print "Hey! the eastern wall of the crypt slid open..."
    FLAGS(FLAG_SECRET_EXIT_LOCATION) = ROOM_TINY_CELL
    gosub ACT_PATCH_DYNAMIC_EXITS_SUB
    return

ACT_TRY_GET_CURRENT_OBJECT_SUB:
    OBJ = FLAGS(FLAG_CURRENT_OBJECT)
    CARRIED_COUNT = 0
    for LOOP_INDEX = 7 to 24
        if ENTITY_LOCATION(LOOP_INDEX) = ENT_LOC_CARRIED then
            CARRIED_COUNT = CARRIED_COUNT + 1
        end if
    next LOOP_INDEX
    if CARRIED_COUNT > 10 then
        print "You are carrying too many objects."
        return
    end if
    ENTITY_LOCATION(OBJ) = ENT_LOC_CARRIED
    return

ACT_DROP_CURRENT_OBJECT_SUB:
    OBJ = FLAGS(FLAG_CURRENT_OBJECT)
    ENTITY_LOCATION(OBJ) = PLAYER_LOCATION
    return

ACT_USE_KEY_FOREST_SUB:
    print "You opened the door."
    ENTITY_LOCATION(OBJ_KEY) = PLAYER_LOCATION
    PLAYER_LOCATION = ROOM_DARK_ROOM
    FLAGS(FLAG_PLAYER_MOVED) = 1
    return

ACT_USE_KEY_TEMPLE_SUB:
    print "You opened the door."
    ENTITY_LOCATION(OBJ_KEY) = PLAYER_LOCATION
    PLAYER_LOCATION = ROOM_CRYPT
    FLAGS(FLAG_PLAYER_MOVED) = 1
    return

ACT_USE_ROPE_SUB:
    print "You descend the rope, but it drops 10 feet short of the floor. You jump the rest of the way."
    ENTITY_LOCATION(OBJ_ROPE) = PLAYER_LOCATION
    PLAYER_LOCATION = ROOM_TEMPLE
    FLAGS(FLAG_PLAYER_MOVED) = 1
    return

ACT_USE_BOMB_SUB:
    if ENTITY_LOCATION(OBJ_BOMB) <> ENT_LOC_CARRIED and ENTITY_LOCATION(OBJ_BOMB) <> PLAYER_LOCATION then
        print "That won't burn, Dummy...In fact, the candle went out."
        FLAGS(FLAG_CANDLE_LIT) = 0
        return
    end if
    if FLAGS(FLAG_CANDLE_LIT) <> 1 then
        print "But the candle is out, stupid!!"
        return
    end if
    print "The fuse burnt away and....BOOM!!....the explosion blew you out of the way (Lucky!)"
    if PLAYER_LOCATION > ROOM_DARK_ROOM then
        PLAYER_LOCATION = PLAYER_LOCATION - 1
        if PLAYER_LOCATION = ROOM_OAK_DOOR then
            FLAGS(FLAG_TELEPORT_DESTINATION) = ROOM_TREASURE_ROOM
            gosub ACT_PATCH_DYNAMIC_EXITS_SUB
        end if
    end if
    ENTITY_LOCATION(OBJ_BOMB) = ENT_LOC_REMOVED
    FLAGS(FLAG_PLAYER_MOVED) = 1
    return

ACT_SWORD_COMBAT_SUB:
    HOSTILE = FLAGS(FLAG_HOSTILE_CREATURE_INDEX)
    if HOSTILE = 0 then
        print "But there's nothing to kill..."
        return
    end if

    FLAGS(FLAG_SWORD_SWING_COUNT) = FLAGS(FLAG_SWORD_SWING_COUNT) + 1

    if RND * 7 + 15 <= FLAGS(FLAG_SWORD_SWING_COUNT) then
        print "You swing with your sword but miss and the creature smashes your skull."
        PLAYER_ALIVE = 0
        return
    end if

    if RND < .38 then
        goto SWORD_KILLS_TARGET_DD
    end if

    if HOSTILE = ENT_BAT then
        gosub ACT_BAT_CARRY_SUB
        return
    end if

    RANDOM_FIGHT_MESSAGE = INT(RND * 4)
    select case RANDOM_FIGHT_MESSAGE
        case 0
            print "You attack but the creature moves aside."
        case 1
            print "The creature deflects your blow."
        case 2
            print "The foe is stunned but quickly regains his balance."
        case 3
            print "You missed and he deals a blow to your head."
    end select
    return

SWORD_KILLS_TARGET_DD:
    print "The sword strikes home and your foe dies..."


    if HOSTILE = ENT_TROLL or HOSTILE = ENT_BAT then
        ENTITY_LOCATION(HOSTILE) = ENTITY_LOCATION(HOSTILE) + 10
    else
        ENTITY_LOCATION(HOSTILE) = ENT_LOC_REMOVED
        if HOSTILE = ENT_WIZARD then
            print "Hey! Your sword has just crumbled into dust!!"
            ENTITY_LOCATION(OBJ_SWORD) = ROOM_TEMPLE
        end if
    end if

    if HOSTILE <> ENT_DRAGON then
        print "Suddenly a black cloud descends and the corpse vaporizes into nothing."
    end if

    FLAGS(FLAG_HOSTILE_CREATURE_INDEX) = 0
    return

ACT_RESOLVE_MOVEMENT_SUB:
    DIR = FLAGS(FLAG_CURRENT_DIR)
    if ENTITY_LOCATION(OBJ_BOMB) <> ENT_LOC_CARRIED and ENTITY_LOCATION(OBJ_BOMB) <> PLAYER_LOCATION and ENTITY_LOCATION(OBJ_BOMB) <> ENT_LOC_REMOVED then
        DIR = INT(RND * 4)
    end if

    TARGET = MOVEMENT_TABLE(PLAYER_LOCATION, DIR)
    if TARGET = EXIT_NONE then
        print "You can't go that way"
        return
    end if
    if TARGET = EXIT_FATAL then
        print "You stumble and fall into the chasm and smash yourself to a pulp on the rocks below."
        PLAYER_ALIVE = 0
        return
    end if
    if TARGET > 0 then
        PLAYER_LOCATION = TARGET
        FLAGS(FLAG_PLAYER_MOVED) = 1
    end if
    return

ACT_SET_BRIDGE_FATAL_AND_PATCH_SUB:
    if FLAGS(FLAG_BRIDGE_CONDITION) <> EXIT_FATAL then
        FLAGS(FLAG_BRIDGE_CONDITION) = EXIT_FATAL
        gosub ACT_PATCH_DYNAMIC_EXITS_SUB
    end if
    return

ACT_SET_HUT_VISITED_SUB:
    FLAGS(FLAG_HUT_VISITED) = 1
    return

ACT_ENABLE_WATER_EXIT_AND_PATCH_SUB:
    FLAGS(FLAG_WATER_EXIT_LOCATION) = ROOM_DRAIN_C
    gosub ACT_PATCH_DYNAMIC_EXITS_SUB
    return

ACT_DISABLE_WATER_EXIT_AND_PATCH_SUB:
    FLAGS(FLAG_WATER_EXIT_LOCATION) = 0
    gosub ACT_PATCH_DYNAMIC_EXITS_SUB
    return

ACT_SET_GATE_DEST_AND_PATCH_SUB:
    FLAGS(FLAG_GATE_DESTINATION) = ROOM_DARK_CAVERN_J
    gosub ACT_PATCH_DYNAMIC_EXITS_SUB
    return

ACT_CLEAR_GATE_DEST_AND_PATCH_SUB:
    FLAGS(FLAG_GATE_DESTINATION) = 0
    gosub ACT_PATCH_DYNAMIC_EXITS_SUB
    return

ACT_SET_DRAWBRIDGE_AND_PATCH_SUB:
    FLAGS(FLAG_DRAWBRIDGE_STATE) = ROOM_DRAWBRIDGE
    gosub ACT_PATCH_DYNAMIC_EXITS_SUB
    return

ACT_CLEAR_DRAWBRIDGE_AND_PATCH_SUB:
    FLAGS(FLAG_DRAWBRIDGE_STATE) = EXIT_FATAL
    gosub ACT_PATCH_DYNAMIC_EXITS_SUB
    return

ACT_CLEAR_TELEPORT_DEST_AND_PATCH_SUB:
    if FLAGS(FLAG_TELEPORT_DESTINATION) <> 0 then
        FLAGS(FLAG_TELEPORT_DESTINATION) = 0
        gosub ACT_PATCH_DYNAMIC_EXITS_SUB
    end if
    return

ACT_CLEAR_SECRET_EXIT_AND_PATCH_SUB:
    if FLAGS(FLAG_SECRET_EXIT_LOCATION) <> 0 then
        FLAGS(FLAG_SECRET_EXIT_LOCATION) = 0
        gosub ACT_PATCH_DYNAMIC_EXITS_SUB
    end if
    return

ACT_PATCH_DYNAMIC_EXITS_SUB:
    MOVEMENT_TABLE(ROOM_BRIDGE_NORTH_ANCHOR,DIR_SOUTH_STR) = FLAGS(FLAG_BRIDGE_CONDITION)
    MOVEMENT_TABLE(ROOM_BRIDGE_SOUTH_ANCHOR,DIR_NORTH_STR) = FLAGS(FLAG_BRIDGE_CONDITION)
    MOVEMENT_TABLE(ROOM_OAK_DOOR,DIR_EAST_STR) = FLAGS(FLAG_TELEPORT_DESTINATION)
    MOVEMENT_TABLE(ROOM_CRYPT,DIR_EAST_STR) = FLAGS(FLAG_SECRET_EXIT_LOCATION)
    MOVEMENT_TABLE(ROOM_TINY_CELL,DIR_NORTH_STR) = FLAGS(FLAG_WATER_EXIT_LOCATION)
    MOVEMENT_TABLE(ROOM_TINY_CELL,DIR_EAST_STR) = FLAGS(FLAG_GATE_DESTINATION)
    MOVEMENT_TABLE(ROOM_CASTLE_LEDGE,DIR_EAST_STR) = FLAGS(FLAG_DRAWBRIDGE_STATE)
    return

ACT_BAT_CARRY_SUB:
    print "The giant bat picked you up and carried you to another place."
    OLDROOM = ENTITY_LOCATION(ENT_BAT)
    ENTITY_LOCATION(ENT_BAT) = OLDROOM + 7
    if ENTITY_LOCATION(ENT_BAT) > ROOM_MAX then
        ENTITY_LOCATION(ENT_BAT) = ROOM_BAT_CAVE
    end if
    PLAYER_LOCATION = ROOM_BAT_CAVE
    FLAGS(FLAG_PLAYER_MOVED) = 1
    return

ACT_MONSTER_ATTACK_AND_KILL_SUB:
    MONSTER_ADJECTIVE$ = @MONSTER_ADJ(FLAGS(FLAG_HOSTILE_CREATURE_INDEX))
    MONSTER_NOUN$ = @MONSTER_NOUN(FLAGS(FLAG_HOSTILE_CREATURE_INDEX))
    print "AUUUUUGH...you've just been killed by a"; MONSTER_ADJECTIVE$; MONSTER_NOUN$; "!!"
    PLAYER_ALIVE = 0
    return

ACT_DESCRIBE_LIT_SUB:
    if ROOM_DESC1_PTR(PLAYER_LOCATION) <> NULL then
        print @ROOM_DESC1_PTR(PLAYER_LOCATION)
    end if
    if ROOM_DESC2_PTR(PLAYER_LOCATION) <> NULL then
        print @ROOM_DESC2_PTR(PLAYER_LOCATION)
    end if

    gosub PRINT_ROOM_EXTRAS_SUB
    gosub LIST_VISIBLE_ENTITIES_SUB
    print
    print ">";
    return

ACT_DESCRIBE_DARK_SUB:
    print "It's very dark, too dark to see anything...I'm scared!"
    gosub LIST_VISIBLE_ENTITIES_SUB
    print
    print ">";
    return

PRINT_ROOM_EXTRAS_SUB:
    if PLAYER_LOCATION > ROOM_LEDGE_WATERFALL_IN and PLAYER_LOCATION < ROOM_WATERFALL_BASE then
        print "Somehow you have gotten into the complex drainage system of this entire cavern network!!"
    end if

    if PLAYER_LOCATION = ROOM_DARK_CAVERN_A or PLAYER_LOCATION = ROOM_DARK_CAVERN_B or PLAYER_LOCATION = ROOM_DARK_CAVERN_C or PLAYER_LOCATION > ROOM_TEMPLE_BALCONY and PLAYER_LOCATION < ROOM_DARK_CAVERN_G or PLAYER_LOCATION = ROOM_DARK_CAVERN_H or PLAYER_LOCATION = ROOM_DARK_CAVERN_I or PLAYER_LOCATION = ROOM_DARK_CAVERN_J or PLAYER_LOCATION = ROOM_DARK_CAVERN_K or PLAYER_LOCATION = ROOM_WOODEN_BRIDGE then
        print "You are deep in a dark cavern."
    end if

    if (PLAYER_LOCATION = ROOM_BRIDGE_NORTH_ANCHOR or PLAYER_LOCATION = ROOM_BRIDGE_SOUTH_ANCHOR) and FLAGS(FLAG_BRIDGE_CONDITION) = EXIT_FATAL then
        print "Two of the ropes have snapped under your weight. It's totally unfit to cross again."
    end if

    if PLAYER_LOCATION = ROOM_CAVE_ENTRANCE_CLEARING and ENTITY_LOCATION(ENT_DRAGON) = ENT_LOC_REMOVED then
        print "You can also see the bloody corpse of an enormous dragon."
    end if

    if PLAYER_LOCATION = ROOM_CASTLE_LEDGE and FLAGS(FLAG_DRAWBRIDGE_STATE) = ROOM_DRAWBRIDGE then
        print " A mighty golden drawbridge spans the waters."
    end if

    if TURN_COUNTER > 200 then
        print "Your candle is growing dim."
    end if
    if TURN_COUNTER >= 230 then
        FLAGS(FLAG_CANDLE_LIT) = 0
        print "In fact...it went out!"
    end if
    return

LIST_VISIBLE_ENTITIES_SUB:
    VISIBLE_OBJECT_COUNT = 0
    for LOOP_INDEX = 7 to 24
        if ENTITY_LOCATION(LOOP_INDEX) = PLAYER_LOCATION then
            VISIBLE_OBJECT_COUNT = VISIBLE_OBJECT_COUNT + 1
        end if
    next LOOP_INDEX

    if VISIBLE_OBJECT_COUNT > 0 then
        print "You can also see..."
        for LOOP_INDEX = 7 to 24
            if ENTITY_LOCATION(LOOP_INDEX) = PLAYER_LOCATION then
                CURRENT_OBJECT_INDEX = LOOP_INDEX
                gosub PRINT_OBJECT_DESCRIPTION_SUB
            end if
        next LOOP_INDEX
    end if

    VISIBLE_CREATURE_COUNT = 0
    for LOOP_INDEX = 1 to 6
        if ENTITY_LOCATION(LOOP_INDEX) = PLAYER_LOCATION then
            VISIBLE_CREATURE_COUNT = VISIBLE_CREATURE_COUNT + 1
            CURRENT_OBJECT_INDEX = LOOP_INDEX
            gosub TRIGGER_CREATURE_INTRO_SUB
        end if
    next LOOP_INDEX

    if VISIBLE_CREATURE_COUNT > 0 then
        print "Nearby there lurks..."
        for LOOP_INDEX = 1 to 6
            if ENTITY_LOCATION(LOOP_INDEX) = PLAYER_LOCATION then
                CURRENT_OBJECT_INDEX = LOOP_INDEX
                gosub PRINT_OBJECT_DESCRIPTION_SUB
            end if
        next LOOP_INDEX
    end if
    return


ACT_NOOP_SUB:
    return

NORMALIZE_INPUT_SUB:
    INPUT_COMMAND$ = LCASE$(INPUT_COMMAND$)
    return

TRIGGER_CREATURE_INTRO_SUB:
    return

PRINT_OBJECT_DESCRIPTION_SUB:
    if CURRENT_OBJECT_INDEX >= 1 and CURRENT_OBJECT_INDEX <= 6 then
        print "A "; @MONSTER_ADJ(CURRENT_OBJECT_INDEX); " "; @MONSTER_NOUN(CURRENT_OBJECT_INDEX)
        return
    end if
    if CURRENT_OBJECT_INDEX >= 7 and CURRENT_OBJECT_INDEX <= 24 then
        print "A "; @OBJECT_NAME_ADJ(CURRENT_OBJECT_INDEX); " "; @OBJECT_NAME_NOUN(CURRENT_OBJECT_INDEX)
        return
    end if
    return

PRINT_RANKING_SUB:
    if FLAGS(FLAG_SCORE) < 10 then
        print "A hopeless beginner."
    elseif FLAGS(FLAG_SCORE) < 30 then
        print "An experienced loser."
    elseif FLAGS(FLAG_SCORE) < 60 then
        print "An average viking."
    elseif FLAGS(FLAG_SCORE) < 100 then
        print "An excellent adventurer."
    else
        print "A perfectionist."
    end if
    return

goto DATA_TABLES_SECTION

DATA_TABLES_SECTION:


MOVEMENT_TABLE_DATA:
    DB ROOM_FOREST_CLEARING,0,0,0
    DB 0,0,ROOM_DARK_FOREST,ROOM_CLOVER_FIELD
    DB ROOM_FOREST_CLEARING,ROOM_RIVER_CLIFF,ROOM_RIVER_CLIFF,0
    DB ROOM_FOREST_CLEARING,ROOM_RIVER_CLIFF,0,ROOM_MT_YMIR_SLOPE
    DB 0,ROOM_RIVER_BANK,ROOM_DARK_FOREST,ROOM_CLOVER_FIELD
    DB ROOM_RIVER_CLIFF,0,ROOM_CRATER_EDGE,ROOM_RIVER_OUTCROP
    DB 0,0,128,ROOM_RIVER_BANK
    DB 0,0,ROOM_RIVER_BANK,0
    DB 0,ROOM_BRIDGE_NORTH_ANCHOR,ROOM_CLOVER_FIELD,0
    DB ROOM_MT_YMIR_SLOPE,ROOM_BRIDGE_MID,ROOM_CLOVER_FIELD,0
    DB ROOM_BRIDGE_NORTH_ANCHOR,ROOM_BRIDGE_SOUTH_ANCHOR,128,128
    DB ROOM_BRIDGE_MID,ROOM_MUSHROOM_ROCK,ROOM_MUSHROOM_ROCK,0
    DB ROOM_BRIDGE_SOUTH_ANCHOR,ROOM_BRIDGE_SOUTH_ANCHOR,ROOM_CAVE_ENTRANCE_CLEARING,ROOM_BRIDGE_SOUTH_ANCHOR
    DB ROOM_CLIFF_FACE,ROOM_CAVE_ENTRY,0,ROOM_MUSHROOM_ROCK
    DB 0,ROOM_CAVE_ENTRANCE_CLEARING,0,0
    DB ROOM_CAVE_ENTRANCE_CLEARING,ROOM_DARK_CAVERN_A,0,ROOM_DEAD_END_INSCRIPTION
    DB 0,0,ROOM_CAVE_ENTRY,0
    DB ROOM_CAVE_ENTRY,0,ROOM_TORTURE_CHAMBER,0
    DB 0,0,ROOM_OAK_DOOR,0
    DB ROOM_DARK_CAVERN_B,ROOM_TORTURE_CHAMBER,0,0
    DB 0,ROOM_NORTH_SOUTH_TUNNEL,0,ROOM_OAK_DOOR
    DB 0,ROOM_TORTURE_CHAMBER,ROOM_DARK_CAVERN_B,ROOM_CAVE_ENTRY
    DB ROOM_WIND_CORRIDOR,0,ROOM_DARK_CAVERN_A,ROOM_DARK_CAVERN_A
    DB ROOM_DARK_CAVERN_B,ROOM_ROUND_ROOM,0,ROOM_DARK_CAVERN_A
    DB 0,ROOM_LEDGE_OVER_RIVER,ROOM_NORTH_SOUTH_TUNNEL,0
    DB ROOM_NORTH_SOUTH_TUNNEL,ROOM_LEDGE_OVER_RIVER,ROOM_DARK_CAVERN_D,ROOM_DARK_CAVERN_C
    DB ROOM_DARK_CAVERN_A,0,0,ROOM_TEMPLE_BALCONY
    DB 0,0,ROOM_LEDGE_OVER_RIVER,0
    DB 0,ROOM_BAT_CAVE,0,ROOM_ROUND_ROOM
    DB ROOM_DARK_CAVERN_D,ROOM_DARK_CAVERN_F,0,0
    DB ROOM_DARK_CAVERN_G,0,0,0
    DB ROOM_BAT_CAVE,ROOM_DARK_CAVERN_E,0,0
    DB 0,ROOM_DARK_CAVERN_F,ROOM_DARK_CAVERN_H,0
    DB 0,0,0,ROOM_BAT_CAVE
    DB 0,0,0,0
    DB ROOM_DARK_CAVERN_J,0,ROOM_TEMPLE,ROOM_LEDGE_WATERFALL_IN
    DB 0,ROOM_TEMPLE,0,0
    DB 0,0,0,0
    DB 0,ROOM_DARK_CAVERN_I,ROOM_TINY_CELL,0
    DB ROOM_WATERFALL_BASE,ROOM_CASTLE_LEDGE,ROOM_DARK_CAVERN_I,128
    DB ROOM_DARK_CAVERN_K,ROOM_DRAIN_C,ROOM_RIVER_CONDUIT,ROOM_DRAIN_B
    DB ROOM_DARK_CAVERN_K,ROOM_DRAIN_C,ROOM_DRAIN_A,ROOM_DRAIN_C
    DB ROOM_DARK_CAVERN_K,ROOM_TINY_CELL,ROOM_DRAIN_B,ROOM_DRAIN_D
    DB ROOM_STONE_STAIRCASE,ROOM_STONE_STAIRCASE,0,ROOM_STONE_STAIRCASE
    DB 0,ROOM_LEDGE_WATERFALL_IN,0,128
    DB ROOM_STONE_STAIRCASE,0,ROOM_STONE_STAIRCASE,ROOM_STONE_STAIRCASE
    DB 0,ROOM_WATERFALL_BASE,ROOM_DARK_CAVERN_K,0
    DB ROOM_LEDGE_WATERFALL_IN,128,0,128
    DB 0,0,ROOM_CASTLE_LEDGE,ROOM_CASTLE_COURTYARD
    DB 0,ROOM_EAST_RIVERBANK,ROOM_DRAWBRIDGE,ROOM_POWDER_MAG
    DB 0,0,ROOM_CASTLE_COURTYARD,0
    DB ROOM_CASTLE_COURTYARD,0,ROOM_WOODEN_BRIDGE,ROOM_CASTLE_COURTYARD
    DB ROOM_RIVER_CONDUIT,0,0,ROOM_EAST_RIVERBANK
    DB 0,ROOM_WOODEN_BRIDGE,ROOM_DRAIN_A,0


OBJECT_LOCATION_DATA:
    DW ROOM_DARK_CAVERN_I, ROOM_TREASURE_ROOM, ROOM_BRIDGE_NORTH_ANCHOR, ROOM_CAVE_ENTRANCE_CLEARING
    DW ROOM_DEAD_END_INSCRIPTION, ROOM_STONE_STAIRCASE, ROOM_RIVER_OUTCROP, ROOM_DARK_ROOM
    DW ROOM_POWDER_MAG, ROOM_WATERFALL_BASE, ROOM_WIND_CORRIDOR, ROOM_DARK_CAVERN_K
    DW ROOM_RIVER_CONDUIT, ROOM_TREASURE_ROOM, ROOM_TREASURE_ROOM, ROOM_TREASURE_ROOM
    DW ROOM_TREASURE_ROOM, EXIT_NONE, ROOM_DARK_CAVERN_H, ROOM_CRATER_EDGE
    DW ROOM_DARK_CAVERN_A, ROOM_CLIFF_FACE, ROOM_NORTH_SOUTH_TUNNEL, ROOM_TINY_CELL


ROOM_DESC1_PTR:
    DW DESC_DARK_ROOM, DESC_FOREST_CLEARING, DESC_DARK_FOREST
    DW DESC_CLOVER_FIELD, DESC_RIVER_CLIFF, DESC_RIVER_BANK
    DW DESC_CRATER_EDGE, DESC_RIVER_OUTCROP, DESC_MT_YMIR
    DW DESC_BRIDGE_NORTH, DESC_BRIDGE_MID, DESC_BRIDGE_SOUTH
    DW DESC_MUSHROOM_ROCK, DESC_CAVE_CLEARING, DESC_CLIFF_FACE
    DW DESC_CAVE_ENTRY, DESC_DEAD_END, NULL
    DW DESC_TREASURE_ROOM, DESC_OAK_DOOR, NULL, DESC_WIND_CORRIDOR
    DW DESC_TORTURE_CHAMBER, DESC_NS_TUNNEL, NULL, DESC_ROUND_ROOM
    DW DESC_LEDGE_RIVER, DESC_TEMPLE_BALCONY
    DW NULL, NULL, NULL, NULL, DESC_BAT_CAVE, NULL, DESC_TEMPLE
    DW NULL, DESC_CRYPT, DESC_TINY_CELL, NULL, DESC_WATERFALL_LEDGE
    DW NULL, NULL, NULL, NULL, DESC_WATERFALL_BASE, NULL, DESC_STONE_STAIR
    DW DESC_CASTLE_LEDGE, DESC_DRAWBRIDGE, DESC_CASTLE_COURTYARD
    DW DESC_POWDER_MAG, DESC_EAST_BANK, DESC_WOODEN_BRIDGE
    DW DESC_RIVER_CONDUIT

ROOM_DESC2_PTR:
    DW NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
    DW NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
    DW NULL, NULL, NULL, NULL, DESC_TORTURE_CHAMBER2, NULL, NULL, DESC_ROUND_ROOM2, NULL, DESC_TEMPLE_BALCONY2
    DW NULL, NULL, NULL, NULL, DESC_BAT_CAVE2, NULL, NULL, NULL, DESC_CRYPT2, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL

DESC_DARK_ROOM: DB "You are standing in a darkened room. There is a door to the north.",0
DESC_FOREST_CLEARING: DB "You are in a forest clearing before a small bark hut. There are no windows, and locked door to the south. The latch was engaged when you closed the door.",0
DESC_DARK_FOREST: DB "You are deep in a dark forest. In the distance you can see a mighty river.",0
DESC_CLOVER_FIELD: DB "You are standing in a field of four-leafed clovers. There is a small hut to the north.",0
DESC_RIVER_CLIFF: DB "The forest has opened up at this point. You are standing on a cliff overlooking a wide glacial river. A small foot-beaten path leads south.",0
DESC_RIVER_BANK: DB "You are standing at the rocky edge of the mighty river Gioll. The path forks east and west.",0
DESC_CRATER_EDGE: DB "You are on the edge of an enormous crater. The rim is extremely slippery. Clouds of water vapour rise high in the air as the Gioll pours into it.",0
DESC_RIVER_OUTCROP: DB "The path to the east stops here. You are on a rocky outcrop, projected about 15 feet above the river. In the distance, a tiny bridge spans the river.",0
DESC_MT_YMIR: DB "You are on the lower slopes of Mt. Ymir. The forest stretches far away and to the west. Arctic winds blow fiercely, it's very cold!",0
DESC_BRIDGE_NORTH: DB "You stand on a rocky precipice high above the river, Gioll; Mt. Ymir stands to the north. A flimsy string bridge spans the mighty river.",0
DESC_BRIDGE_MID: DB "You have made your way half way across the creaking bridge. It sways violently from side to side. It's going to collapse any second!!",0
DESC_BRIDGE_SOUTH: DB "You are on the southern edge of the mighty river, before the string bridge.",0
DESC_MUSHROOM_ROCK: DB "You are standing on a rock in the middle of a mighty oak forest. Surrounding you are thousands of poisonous mushrooms.",0
DESC_CAVE_CLEARING: DB "You are in a clearing in the forest. An ancient basalt rock formation towers above you. To your south is the entrance of a VERY interesting cave...",0
DESC_CLIFF_FACE: DB "You are on a cliff face over looking the river.",0
DESC_CAVE_ENTRY: DB "You are just inside the cave. Sunlight pours into the cave lighting a path to the east and another to the south. I don't mind saying I'm a bit scared!",0
DESC_DEAD_END: DB "This passage appears to be a dead end. On a wall before you is carved `Find the Sacred Key of Thialfi'.",0
DESC_TREASURE_ROOM: DB "You are in the legendary treasure room of the black elves of Svartalfheim. Every red-blooded Viking has dreamed of entering this sacred room.",0
DESC_OAK_DOOR: DB "You can see a small oak door to the east. It has been locked from the inside.",0
DESC_WIND_CORRIDOR: DB "You are standing in an east-west corridor. You can feel a faint breeze coming from the east.",0
DESC_TORTURE_CHAMBER: DB "You are standing in what appears to have once been a torture chamber. Apart from the rather comprehensive range of instumentsof absolutely inhuman agony,",0
DESC_TORTURE_CHAMBER2: DB "coagulated blood stains on the walls and mangled bits of bone on the floor make me think that a number of would be adventurers croaked it here!",0
DESC_NS_TUNNEL: DB "You stand in a long tunnel which has been bored out of the rock.It runs from north to south. A faint glow comes from a narrow crack in the eastern wall.",0
DESC_ROUND_ROOM: DB "You are in a large round room with a number of exits. The walls have been painted in a mystical dark purple and a big chalk staris drawn in the centre of ",0
DESC_ROUND_ROOM2: DB "the floor. Note: This is one of the hidden chambers of the infamous pagan sect, the monks of Loki. Norse folk believe them to be gods.",0
DESC_LEDGE_RIVER: DB "You are standing on a narrow ledge, high above a subterranean river. There is an exit to the east.",0
DESC_TEMPLE_BALCONY: DB "You are on a balcony, overlooking a huge cavern which has been converted into a pagan temple. Note: this temple has been dedicated to Loki, the god of",0
DESC_TEMPLE_BALCONY2: DB "fire, who came to live in Svartalfheim after he had been banished to exile by Odin. Since then he has been waiting for the `End Of All Things'.",0
DESC_BAT_CAVE: DB "You are in the central cave of a giant bat colony. Above you hundreds of giant bats hang from the ceiling and the floor is covered in centuries of ",0
DESC_BAT_CAVE2: DB "giant bat droppings. Careful where you step! Incidentally, the smell is indescribable.",0
DESC_TEMPLE: DB "You are in the temple. To the north is a locked gate and on the wall is a giant statue of Loki, carved out of the living rock itself!",0
DESC_CRYPT: DB "You stand in an old and musty crypt, the final resting place of hundreds of Loki devotees. On the wall is carved:``What 3 letter word completes a word ",0
DESC_CRYPT2: DB "starting with 'G---' and another ending with '---X'' Note: The monks of Loki must have liked silly puzzles. Putrefaction and decay fills the air here.",0
DESC_TINY_CELL: DB "You are in a tiny cell. The western wall has now firmly closed again. There is a ventilator shaft on the eastern wall.",0
DESC_WATERFALL_LEDGE: DB "You are on another ledge high above a subterranean river. The water flows in through a hole in the cavern roof, to the north.",0
DESC_WATERFALL_BASE: DB "You are standing near an enormous waterfall which brings water down from the surface, from the river Gioll.",0
DESC_STONE_STAIR: DB "You are standing before a stone staircase which leads southwards.",0
DESC_CASTLE_LEDGE: DB "You are on a narrow and crumbling ledge. On the other side of the river you can see a magic castle. (Don't ask me why it's magic...I just know it is)",0
DESC_DRAWBRIDGE: DB "You are by the drawbridge which has just lowered itself....by magic!!",0
DESC_CASTLE_COURTYARD: DB "You are in the courtyard of the magic castle. WOW! This castle is really something! On the wall is inscribed 'hzb tzozi'. A secret escape tunnel leads south",0
DESC_POWDER_MAG: DB "You are in the powder magazine of this really super castle.",0
DESC_EAST_BANK: DB "You are on the eastern side of the river. A small tunnel leads east into the cliff face.",0
DESC_WOODEN_BRIDGE: DB "You stand before a small wooden bridge which crosses the river.",0
DESC_RIVER_CONDUIT: DB "You are in a conduit draining into the river. The water comes up to your knees and is freezing cold. A narrow service path leads south.",0


VERB_PATTERN_DATA:
    DW VERB_TAKE, VERB_PUT, VERB_USING, VERB_WITH, VERB_CUT
    DW VERB_BREAK, VERB_UNLOCK, VERB_OPEN, VERB_KILL, VERB_ATTACK
    DW VERB_LIGHT, VERB_BURN, VERB_UP, VERB_DOWN, VERB_JUMP, VERB_SWIM

VERB_TAKE: DB "take",0
VERB_PUT: DB "put",0
VERB_USING: DB "using",0
VERB_WITH: DB "with",0
VERB_CUT: DB "cut",0
VERB_BREAK: DB "break",0
VERB_UNLOCK: DB "unlock",0
VERB_OPEN: DB "open",0
VERB_KILL: DB "kill",0
VERB_ATTACK: DB "attack",0
VERB_LIGHT: DB "light",0
VERB_BURN: DB "burn",0
VERB_UP: DB "up",0
VERB_DOWN: DB "down",0
VERB_JUMP: DB "jump",0
VERB_SWIM: DB "swim",0

DIR_WORD_INDEX_DATA:
    DW DIR_NORTH_STR, DIR_SOUTH_STR, DIR_WEST_STR, DIR_EAST_STR

DIR_NORTH_STR: DB " north ",0
DIR_SOUTH_STR: DB " south ",0
DIR_WEST_STR: DB " west ",0
DIR_EAST_STR: DB " east ",0


MONSTER_ADJ_DATA:
    DW MON_ADJ_WIZ, MON_ADJ_DEMON, MON_ADJ_TROLL, MON_ADJ_DRAGON, MON_ADJ_BAT, MON_ADJ_DWARF

MON_ADJ_WIZ: DB "n evil",0
MON_ADJ_DEMON: DB " fiery",0
MON_ADJ_TROLL: DB "n axe wielding",0
MON_ADJ_DRAGON: DB " fire breathing",0
MON_ADJ_BAT: DB " giant",0
MON_ADJ_DWARF: DB "n old and gnarled",0

MONSTER_NOUN_DATA:
    DW MON_NOUN_WIZ, MON_NOUN_DEMON, MON_NOUN_TROLL, MON_NOUN_DRAGON, MON_NOUN_BAT, MON_NOUN_DWARF

MON_NOUN_WIZ: DB " wizard ",0
MON_NOUN_DEMON: DB " demon ",0
MON_NOUN_TROLL: DB " troll ",0
MON_NOUN_DRAGON: DB " dragon ",0
MON_NOUN_BAT: DB " bat ",0
MON_NOUN_DWARF: DB " dwarf ",0

OBJECT_NAME_ADJ_DATA:
    DW OBJ_ADJ_COIN, OBJ_ADJ_COMPASS, OBJ_ADJ_BOMB, OBJ_ADJ_RUBY, OBJ_ADJ_DIAMOND, OBJ_ADJ_PEARL, OBJ_ADJ_STONE, OBJ_ADJ_RING, OBJ_ADJ_PENDANT, OBJ_ADJ_GRAIL, OBJ_ADJ_SHIELD
    DW OBJ_ADJ_BOX, OBJ_ADJ_KEY, OBJ_ADJ_SWORD, OBJ_ADJ_CANDLE, OBJ_ADJ_ROPE, OBJ_ADJ_BRICK, OBJ_ADJ_GRILL

OBJ_ADJ_COIN: DB " gold",0
OBJ_ADJ_COMPASS: DB " useful looking",0
OBJ_ADJ_BOMB: DB " home made",0
OBJ_ADJ_RUBY: DB " blood red",0
OBJ_ADJ_DIAMOND: DB " sparkling",0
OBJ_ADJ_PEARL: DB " moon-like",0
OBJ_ADJ_STONE: DB "n interesting",0
OBJ_ADJ_RING: DB " diamond studded",0
OBJ_ADJ_PENDANT: DB " magic",0
OBJ_ADJ_GRAIL: DB " most holy",0
OBJ_ADJ_SHIELD: DB " mirror like",0
OBJ_ADJ_BOX: DB " nondescript black",0
OBJ_ADJ_KEY: DB "n old an rusty",0
OBJ_ADJ_SWORD: DB " double bladed",0
OBJ_ADJ_CANDLE: DB " small",0
OBJ_ADJ_ROPE: DB " thin and tatty",0
OBJ_ADJ_BRICK: DB " red house",0
OBJ_ADJ_GRILL: DB " rusty ventilation",0

OBJECT_NAME_NOUN_DATA:
    DW OBJ_NOUN_COIN, OBJ_NOUN_COMPASS, OBJ_NOUN_BOMB, OBJ_NOUN_RUBY, OBJ_NOUN_DIAMOND, OBJ_NOUN_PEARL, OBJ_NOUN_STONE, OBJ_NOUN_RING, OBJ_NOUN_PENDANT, OBJ_NOUN_GRAIL, OBJ_NOUN_SHIELD
    DW OBJ_NOUN_BOX, OBJ_NOUN_KEY, OBJ_NOUN_SWORD, OBJ_NOUN_CANDLE, OBJ_NOUN_ROPE, OBJ_NOUN_BRICK, OBJ_NOUN_GRILL

OBJ_NOUN_COIN: DB " coin ",0
OBJ_NOUN_COMPASS: DB " compass ",0
OBJ_NOUN_BOMB: DB " bomb ",0
OBJ_NOUN_RUBY: DB " ruby ",0
OBJ_NOUN_DIAMOND: DB " diamond ",0
OBJ_NOUN_PEARL: DB " pearl ",0
OBJ_NOUN_STONE: DB " stone ",0
OBJ_NOUN_RING: DB " ring ",0
OBJ_NOUN_PENDANT: DB " pendant ",0
OBJ_NOUN_GRAIL: DB " grail ",0
OBJ_NOUN_SHIELD: DB " shield ",0
OBJ_NOUN_BOX: DB " box ",0
OBJ_NOUN_KEY: DB " key ",0
OBJ_NOUN_SWORD: DB " sword ",0
OBJ_NOUN_CANDLE: DB " candle ",0
OBJ_NOUN_ROPE: DB " rope ",0
OBJ_NOUN_BRICK: DB " brick ",0
OBJ_NOUN_GRILL: DB " grill ",0

OBJDESC1_DATA:
    DW MON_ADJ_WIZ, MON_ADJ_DEMON, MON_ADJ_TROLL
    DW MON_ADJ_DRAGON, MON_ADJ_BAT, MON_ADJ_DWARF
    DW OBJ_ADJ_COIN, OBJ_ADJ_COMPASS, OBJ_ADJ_BOMB, OBJ_ADJ_RUBY
    DW OBJ_ADJ_DIAMOND, OBJ_ADJ_PEARL, OBJ_ADJ_STONE, OBJ_ADJ_RING
    DW OBJ_ADJ_PENDANT, OBJ_ADJ_GRAIL, OBJ_ADJ_SHIELD, OBJ_ADJ_BOX
    DW OBJ_ADJ_KEY, OBJ_ADJ_SWORD, OBJ_ADJ_CANDLE, OBJ_ADJ_ROPE
    DW OBJ_ADJ_BRICK, OBJ_ADJ_GRILL

OBJDESC2_DATA:
    DW MON_NOUN_WIZ, MON_NOUN_DEMON, MON_NOUN_TROLL
    DW MON_NOUN_DRAGON, MON_NOUN_BAT, MON_NOUN_DWARF
    DW OBJ_NOUN_COIN, OBJ_NOUN_COMPASS, OBJ_NOUN_BOMB, OBJ_NOUN_RUBY
    DW OBJ_NOUN_DIAMOND, OBJ_NOUN_PEARL, OBJ_NOUN_STONE, OBJ_NOUN_RING
    DW OBJ_NOUN_PENDANT, OBJ_NOUN_GRAIL, OBJ_NOUN_SHIELD, OBJ_NOUN_BOX
    DW OBJ_NOUN_KEY, OBJ_NOUN_SWORD, OBJ_NOUN_CANDLE, OBJ_NOUN_ROPE
    DW OBJ_NOUN_BRICK, OBJ_NOUN_GRILL


UPDATE_DYNAMIC_EXITS_SUB:


    MOVEMENT_TABLE(ROOM_BRIDGE_NORTH_ANCHOR,DIR_SOUTH_STR) = BRIDGE_CONDITION
    MOVEMENT_TABLE(ROOM_BRIDGE_SOUTH_ANCHOR,DIR_NORTH_STR) = BRIDGE_CONDITION
    MOVEMENT_TABLE(ROOM_OAK_DOOR,DIR_EAST_STR) = TELEPORT_DESTINATION
    MOVEMENT_TABLE(ROOM_CRYPT,DIR_EAST_STR) = SECRET_EXIT_LOCATION
    MOVEMENT_TABLE(ROOM_TINY_CELL,DIR_NORTH_STR) = WATER_EXIT_LOCATION
    MOVEMENT_TABLE(ROOM_TINY_CELL,DIR_EAST_STR) = GATE_DESTINATION
    MOVEMENT_TABLE(ROOM_CASTLE_LEDGE,DIR_EAST_STR) = DRAWBRIDGE_STATE
    return
